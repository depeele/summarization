(function(a){a.Note=function(b){var c={id:null,comments:[],tags:[]};return this.init(a.extend(c,true,b||{}))};a.Note.prototype={init:function(b){this.props=b;var c=[];a.each(this.props.comments,function(){var d=this;if(a.isPlainObject(d)){d=new a.Comment(d)}c.push(d)});if(c.length<1){c.push(new a.Comment())}this.props.comments=c;return this},addComment:function(b){if(a.isPlainObject(b)){b=new a.Comment(b)}this.props.comments.push(b);return b},removeComment:function(d){var b=this;if(d instanceof a.Comment){var c=-1;a.each(b.props.comments,function(e){if(this===d){c=e;return false}});if(c>=0){b.props.comments.splice(c,1);d.destroy()}}return b},getId:function(){return this.props.id},getComments:function(){return this.props.comments},getCommentCount:function(){return this.props.comments.length},getTags:function(){return this.props.tags},getComment:function(b){b=b||0;return this.props.comments[b]},getTag:function(b){b=b||0;return this.props.tags[b]},serialize:function(){var b={id:this.props.id,comments:[],tags:this.props.tags};a.each(this.props.comments,function(){b.comments.push(this.serialize())});return b},destroy:function(){var b=this;var c=b.props;if(a.isArray(c.comments)){a.each(c.comments,function(){this.destroy()})}delete c.comments;delete c.tags}};a.Comment=function(b){var c={author:null,text:"",created:new Date()};return this.init(a.extend(c,true,b||{}))};a.Comment.prototype={init:function(b){this.props=b;if((this.props.author===null)||(a.isPlainObject(this.props.author))){this.props.author=new a.User(this.props.author)}return this},getAuthor:function(){return this.props.author},getText:function(){return this.props.text},getCreated:function(){return this.props.created},setText:function(b){this.props.text=b},serialize:function(){var b={author:(this.props.author?this.props.author.serialize():null),text:this.props.text,created:this.props.created};return b},destroy:function(){var b=this;var c=b.props;if(c.author&&(c.author instanceof a.User)){c.author.destroy()}delete c.author;delete c.text;delete c.created}}}(jQuery));(function(a){a.widget("ui.note",{version:"0.0.1",widgetEventPrefix:"note-",options:{note:null,container:".notes-pane",position:{my:"top",at:"top",of:null,using:null},animSpeed:200,hidden:false,template:"#tmpl-note"},_init:function(){var b=this;var c=b.options;b._isInitializing=true;b.$container=a(c.container);if(a.isPlainObject(c.note)){if((c.note.id===undefined)||(c.note.id===null)){c.note.id=b.element.attr("id")}c.note=new a.Note(c.note)}b._widgetCreate()._bindEvents();b._isInitializing=false;return b},id:function(){var b=this;var c=b.options;return c.note.getId()},commentCount:function(){var b=this;var c=b.options;return c.note.getCommentCount()},addComment:function(e){var b=this;var c=b.options;var d=a("<div />").comment({comment:e});b.$body.append(d);if(b._isInitializing!==true){var e=d.comment("option","comment");c.note.addComment(e);b._trigger("change",null,"commentAdded")}return b},removeComment:function(d){var b=this;var c=b.options;var e=d.comment("option","comment");c.note.removeComment(e);b._trigger("change",null,"commentRemoved");if(b.commentCount()<1){b.destroy()}return b},activate:function(){var c=this;var d=c.options;if(c.element.hasClass("note-active")){return}var b=c.$buttons.filter("[name=reply]");if((!c.$reply.hasClass("hint"))&&(c.$reply.val().length>0)){c.$buttons.show();b.button("enable")}else{c.$buttons.hide();b.button("disable");c.$reply.addClass("hint").val(c.$reply.attr("title"))}var e=parseInt(c.element.css("z-index"),10);c.element.css("z-index",e+1).addClass("note-active",d.animSpeed,function(){c.element.css("z-index","")})},deactivate:function(){var b=this;var c=b.options;if(!b.element.hasClass("note-active")){return}b.element.find(".note .buttons [name=cancel]").click();b.element.removeClass("note-active",c.animSpeed)},show:function(){var b=this;var c=b.options;b.element.fadeIn(c.animSpeed).position(c.position)},hide:function(b){var c=this;var d=c.options;c.element.fadeOut(d.animSpeed,b)},focus:function(){var b=this;var c=b.options;b.$reply.trigger("focus")},hasFocus:function(){var b=this;var c=b.options;return b.$reply.is(":focus")},serialize:function(){var b=this;var c=b.options;return c.note.serialize()},destroy:function(){var b=this;var c=b.options;b._unbindEvents().hide(function(){b._widgetDestroy();c.note.destroy();b._trigger("destroyed")})},_widgetCreate:function(){var b=this;var c=b.options;if(c.position.using===null){c.position.using=function(h){var g=b.element.offset();var d=g.top+h.top;var f=d+b.element.height();var e=b.element.attr("id");b.$container.find(".note").each(function(){var i=a(this);if(e===i.attr("id")){return}var k=i.offset();var j={top:k.top,bot:k.top+i.height()};if(((d>=j.top)&&(d<=j.bot))||((f>=j.top)&&(f<=j.bot))){h.top+=i.height()+4}});a(this).animate({top:h.top},c.animSpeed)}}b.element.addClass("note ui-corner-all").attr("id","note-"+b.id()).append(a(c.template).tmpl()).appendTo(b.$container);if(c.hidden===true){b.element.hide()}b.$body=b.element.find(".note-body");b.$reply=b.element.find(".note-reply");b.$buttons=b.element.find(".note-input-pane .buttons button");b.$buttons.button();a.each(c.note.getComments(),function(){b.addComment(this,true)});if(c.hidden!==true){b.element.position(c.position)}return b},_widgetDestroy:function(){var b=this;var c=b.options;b.$body.find(".note").note("destroy");b.$buttons.button("destroy");b.element.empty();return b},_bindEvents:function(){var b=this;var c=b.options;b._docClick=function(f){var d=a(f.target);if(d!==b.element){b.deactivate()}};a(document).bind("click.ui-note",b._docClick);b.element.delegate(".note-input-pane button","click.ui-note",function(f){var d=a(this);switch(d.attr("name")){case"reply":var g=new a.Comment({text:b.$reply.val()});b.addComment(g);b.$reply.val("");break;case"cancel":b.$reply.val("");b.$reply.blur();break}});b.$reply.bind("keyup.ui-note",function(f){var d=b.$buttons.filter("[name=reply]");if((!b.$reply.hasClass("hint"))&&(b.$reply.val().length>0)){d.button("enable")}else{d.button("disable")}});b.element.bind("click.ui-note",function(d){b.activate();return false});b.element.delegate(".comment","comment-destroyed",function(f,g){var d=a(f.target);b.removeComment(d)});b.$reply.bind("focus.ui-note",function(f){b.$buttons.show();var d=b.$buttons.filter("[name=reply]");if(b.$reply.hasClass("hint")){b.$reply.val("").removeClass("hint")}if(b.$reply.val().length>0){d.button("enable")}else{d.button("disable")}});b.$reply.bind("blur.ui-note",function(f){var d=b.$buttons.filter("[name=reply]");if(b.$reply.val().length>0){d.button("enable")}else{b.$reply.addClass("hint").val(b.$reply.attr("title"));b.$buttons.hide();d.button("disable")}});return b},_unbindEvents:function(){var b=this;var c=b.options;b.element.undelegate(".note-input-pane button","click.ui-note");b.$reply.unbind(".ui-note");b.element.unbind(".ui-note");b.element.undelegate(".comment","comment-destroyed");a(document).bind("click.ui-note",b._docClick);return b}});a.widget("ui.comment",{version:"0.0.1",widgetEventPrefix:"comment-",options:{comment:null,template:"#tmpl-comment"},serialize:function(){var b=this;var c=b.options;return c.comment.serialize()},destroy:function(){var b=this;var c=b.options;b._unbindEvents()._widgetDestroy();b._trigger("destroyed",null,c.comment)},_init:function(){var b=this;var c=b.options;if(a.isPlainObject(c.comment)){c.comment=new a.Comment(c.comment)}b._widgetCreate()._bindEvents();return b},_widgetCreate:function(){var b=this;var c=b.options;b.element.addClass("comment").append(a(c.template).tmpl({note:c.comment}));b.$comment=b.element.find(".text");b.$editArea=b.element.find(".edit");b.$edit=b.$editArea.find("textarea");b.$buttons=b.element.find(".buttons button");b.$mainButtons=b.element.find(".buttons:last");b.$buttons.button();return b},_widgetDestroy:function(){var b=this;var c=b.options;b.$buttons.button("destroy");b.element.empty();return b},_bindEvents:function(){var b=this;var c=b.options;b.$buttons.bind("click.ui-comment",function(f){var d=a(this);switch(d.attr("name")){case"edit":b.$edit.val(b.$comment.text());b.$comment.hide();b.$mainButtons.css("display","none");b.$editArea.show();b.$edit.focus();break;case"delete":b.element.slideUp(function(){b.element.remove()});break;case"save":c.comment.setText(b.$edit.val());b.$comment.text(c.comment.getText());b._trigger("change",null,"commentSaved");case"cancel":b.$editArea.hide();b.$comment.show();b.$mainButtons.css("display","");break}});return b},_unbindEvents:function(){var b=this;var c=b.options;b.$buttons.unbind(".ui-comment");return b}})}(jQuery));(function(a){a.widget("ui.sentence",{version:"0.0.1",widgetEventPrefix:"sentence-",options:{notesPane:".notes-pane",rank:0,highlighted:false,expanded:false,starred:false,noExpansion:false,animSpeed:200,css:{highlighted:"highlight",expanded:"expanded",expansion:"expansion",starred:"starred",noExpansion:"hide-expand",selected:"selected",tagged:"ui-state-default tagged"}},_init:function(){var b=this;var c=this.options;c.enabled=b.element.attr("disabled")?false:true;if(c.rank<=0){var d=parseInt(b.element.attr("rank"),10);if(!isNaN(d)){c.rank=d}}b._widgetInit()._eventsBind()},isVisible:function(){return(this.element.filter(".highlight,.expanded,.expansion,.keyworded").length>0)},highlight:function(){return this._setOption("highlighted",true)},unhighlight:function(){return this._setOption("highlighted",false)},expand:function(){return this._setOption("expanded",true)},collapse:function(){return this._setOption("expanded",false)},star:function(b){return this._setOption("starred",b)},serialize:function(){var c=this;var d=c.options;var b={rank:d.rank,starred:d.starred,notes:c._serializeNotes()};return b},toggleOption:function(c){var b=this;var d=b.options;if(d[c]){b._setOption(c,false)}else{b._setOption(c,true)}return b},syncNotePositions:function(){var c=this;var d=c.options;var b=c.element;var e=c.isVisible();b.find(".tagged").each(function(){var g=a(this);var f=g.data("note-associate");if(!f){return}f.note((e?"show":"hide"))});return c},destroy:function(){this._eventsUnbind()._widgetClean();return this},_widgetInit:function(){var c=this;var d=c.options;var b=c.element;c.$content=c.element.find(".content");c.$content.contentOverlay();c.$notesPane=a(".notes-pane");c.notes=[];b[d.highlighted?"addClass":"removeClass"](d.css.highlighted);b[d.expanded?"addClass":"removeClass"](d.css.expanded);b[d.starred?"addClass":"removeClass"](d.css.starred);b[d.noExpansion?"addClass":"removeClass"](d.css.noExpansion);if(d.notes){c._unserializeNotes(d.notes)}return c},_widgetClean:function(){var b=this;var c=b.options;return b},_setOption:function(d,f){var b=this;var e=b.options;var c=false;switch(d){case"disabled":if(f){b._trigger("disabled")}else{b._trigger("enabled")}break;case"expanded":if(f){b._expand()}else{b._collapse()}break;case"highlighted":if(f){b._highlight()}else{b._unhighlight()}break;case"starred":b.widget()[f?"addClass":"removeClass"](e.css.starred);c=(f?"starred":"unstarred");break;case"noExpansion":b.widget()[f?"addClass":"removeClass"](e.css.noExpansion);break}a.Widget.prototype._setOption.apply(b,arguments);if(c!==false){b._trigger("change",null,c)}},_serializeNotes:function(){var b=this;var c=[];a.each(b.notes,function(){var d=a(this);if(!d.data("note")){return}var e=d.data("note-associate");c.push({range:e.overlayGroup("serialize"),note:d.note("serialize")})});return c},_unserializeNotes:function(d){var b=this;var c=(!b.isVisible());if(b.notes.length>0){}b.notes=[];a.each(d,function(){if((!this.range)||(!this.note)){return}var e=b.$content.contentOverlay("addOverlay",this.range,"tag");b._addNote(e,this.note,c)});return b.notes},_highlight:function(){var c=this;var e=c.options;var b=c.element;if((e.highlighted===true)||(b.data("isHighlighting"))){return}var d=c.element.find(".controls .expand");var f=function(){b.css("display","").removeData("isHighlighting");c.$content.contentOverlay("refresh");c.syncNotePositions();c._trigger("highlighted");c._trigger("change",null,"highlighted")};b.data("isHighlighting",true);b.addClass(e.css.highlighted,e.animSpeed,f)},_unhighlight:function(){var c=this;var d=c.options;var b=c.element;if((d.highlighted===false)||(b.data("isHighlighting"))){return}var e=function(){b.css("display","").removeData("isHighlighting");c.$content.contentOverlay("refresh");c.syncNotePositions();c._trigger("unhighlighted");c._trigger("change",null,"unhighlighted")};b.data("isHighlighting",true);if(b.hasClass(d.css.highlighted)){b.removeClass(d.css.highlighted,d.animSpeed,e)}else{if(b.hasClass(d.css.expansion)){e()}}},_expand:function(){var e=this;var g=e.options;var b=e.element;if((g.expanded===true)||(b.data("isExpanding"))){return}var f=b.find(".controls .expand");var d=b.prev();var c=b.next();var h=function(){b.addClass(g.css.expansion).css("display","").removeData("isExpanding");f.attr("title","collapse");e.$content.contentOverlay("refresh");e.syncNotePositions();e._trigger("expanded");e._trigger("change",null,"expanded")};b.data("isExpanding",true);b.addClass(g.css.expanded,g.animSpeed,h);if(!d.sentence("isVisible")){d.addClass(g.css.expansion,g.animSpeed,h)}if(!c.sentence("isVisible")){c.addClass(g.css.expansion,g.animSpeed,h)}},_collapse:function(){var j=this;var b=j.options;var h=j.element;if((b.expanded===false)||(h.data("isCollapsing"))){return}var c=h.find(".controls .expand");var d=h.prev();var g=h.next();var i=1;var e=function(){if(--i>0){return}h.removeClass(b.css.expansion).css("display","").removeData("isCollapsing");if(!h.hasClass("highlight")){h.removeClass("ui-hover").find(".controls .ui-icon").css("opacity","").end().find(".overlay-controls").hide()}c.attr("title","expand");j.$content.contentOverlay("refresh");j.syncNotePositions();j._trigger("collapsed");j._trigger("change",null,"collapsed")};var f=function(k){++i;k.removeClass(b.css.expansion,b.animSpeed,e);if(k.hasClass("expanded")){k.sentence("expanded",false)}};h.data("isCollapsing",true);if(h.hasClass(b.css.expanded)){h.removeClass(b.css.expanded,b.animSpeed,e)}else{if(h.hasClass(b.css.expansion)){h.removeClass(b.css.expansion,b.animSpeed,e)}}if(d.hasClass(b.css.expansion)){f(d)}if(g.hasClass(b.css.expansion)){f(g)}},_addNote:function(g,f,d){var c=this;var h=c.options;var e;if(!f){e=c.notes.length;f={id:e}}else{if(!(f instanceof a.Note)){f=new a.Note(f)}e=f.getId()}var b=a("<div />").note({container:h.notesPane,note:f,position:{of:g},hidden:(d?true:false)});c.notes[e]=b;b.data("note-associate",g);g.data("note-associate",b);b.bind("note-change.ui-sentence",function(j,i){c._trigger("change",null,i)});b.bind("note-destroyed.ui-sentence",function(i){c._removeNote(b)});b.bind("comment-change.ui-sentence",function(j,i){if(i==="commentSaved"){c._trigger("change",null,i)}});c._trigger("change",null,"noteAdded")},_removeNote:function(b){if(!b){return}var c=this;var e=c.options;var d=b.data("note-associate");var f=b.note("id");if(!b.data("note-destroying")){b.data("note-destroying",true);b.note("destroy");return}b.unbind(".ui-sentence").removeData("note-associate");d.removeData("note-associate").overlayGroup("destroy");c.notes[f]=undefined;c._trigger("change",null,"noteRemoved")},_eventsBind:function(){var c=this;var b=c.element;b.hoverIntent(function(d){if(b.data("isCollapsing")||(!c.isVisible())){return}switch(d.type){case"mouseenter":b.addClass("ui-hover");break;case"mouseleave":b.removeClass("ui-hover");break}});b.delegate(".controls .su-icon","mouseenter mouseleave",function(f){var d=a(this);switch(f.type){case"mouseenter":d.css("opacity",1);break;case"mouseleave":d.css("opacity","");break}});b.delegate(".controls .su-icon","click",function(g){var d=a(this);var f=false;if(d.hasClass("star")){c.toggleOption("starred");f=true}else{if(d.hasClass("expand")){c.toggleOption("expanded");f=true}}if(f){g.stopPropagation();return false}});b.bind("overlaygroup-action.ui-sentence",function(i,h){var g=a(i.target);var f=a(h);console.log("overlaygroup-action: ctl[ "+f.attr("class")+" ]");if(f.hasClass("tag")){g.overlayGroup("changeType","tag");c._addNote(g)}else{if(f.hasClass("remove")){var d=g.data("note-associate");c._removeNote(d)}}});b.bind("overlaygroup-hover-in.ui-sentence overlaygroup-hover-out.ui-sentence",function(g){var f=a(g.target);var d=f.data("note-associate");if(d){if(g.type==="overlaygroup-hover-in"){d.note("activate")}else{if(!d.note("hasFocus")){d.note("deactivate")}}}});b.delegate(".tagged","click",function(g){var f=a(g.target);var d=f.data("note-associate");if(d){d.note("focus");g.preventDefault();g.stopPropagation();return false}});return c},_eventsUnbind:function(){var c=this;var b=c.element;c.element.unhoverIntent();b.undelegate(".controls .su-icon","mouseenter mouseleave");b.undelegate(".controls .su-icon","click");b.unbind(".ui-sentence");b.unhoverIntent();return c}})}(jQuery));(function(a){a.widget("ui.contentOverlay",{version:"0.0.1",widgetEventPrefix:"contentOverlay-",options:{types:{selection:{cssClass:"selected",template:"#tmpl-overlay-controls"},tag:{cssClass:"tagged",template:"#tmpl-overlay-remove-controls"},}},_init:function(){var b=this;var c=this.options;b.$groups=a();rangy.init();b._widgetInit()._eventsBind()},refresh:function(){var b=this;var c=b.options;b.$groups=b.$overlay.find(".group");b.$groups.overlayGroup("refresh")},addOverlay:function(c,e){var b=this;var f=b.options;var g=a.ui.overlayGroup.types[e];if(g===undefined){return}var d=a("<div />").appendTo(b.$overlay).overlayGroup({cssClass:g.cssClass,template:g.template,content:b.element,range:c});b.$groups=b.$overlay.find(".group");return d},removeAll:function(d){var b=this;var e=b.options;if(b.$groups.length<1){return}var c=b.$groups;if(d){var f=a.ui.overlayGroup.types[d];if(f===undefined){return}c=c.filter("."+f.cssClass)}c.overlayGroup("destroy")},destroy:function(){this._eventsUnbind()._widgetClean();return this},_widgetInit:function(){var b=this;var c=b.options;b.$overlay=a("<div />").addClass("overlay").insertBefore(b.element);return b},_widgetClean:function(){var b=this;var c=b.options;b.removeAll();b.$overlay.remove();return b},_eventsBind:function(){var b=this;var c=b.options;b.element.bind("mousemove mouseleave mousedown mouseup click",function(h){var g=null;b.$groups.each(function(){g=a(this).overlayGroup("hitTest",h);if(g!==null){return false}});if((g===null)&&(h.type==="mouseup")){var f=rangy.getSelection();var d=f.toString();b.removeAll("selection");if(d.length>0){b.addOverlay(f.getRangeAt(0),"selection");h.preventDefault();h.stopPropagation();return false}}});b.$overlay.bind("overlaygroup-destroyed",function(f){var d=a(f.target);d.remove();b.$groups=b.$overlay.find(".group")});return b},_eventsUnbind:function(){var b=this;return b}});a.widget("ui.overlayGroup",{version:"0.0.1",widgetEventPrefix:"overlayGroup-",options:{cssClass:"selected",template:"#tmpl-overlay-controls",segments:[],content:null,range:null,hoverDelta:5},_init:function(){var b=this;var c=this.options;if((c.range!==null)&&(c.range instanceof rangy.WrappedRange)){b.wrappedRange=c.range}b._widgetInit()._eventsBind()},destroy:function(){var b=this;if(b._destroyed){return}b._eventsUnbind()._widgetClean();b.element.empty();b._destroyed=true;b._trigger("destroyed");return b},serialize:function(){var b=this;var c=b.options;return c.range},unserialize:function(d){var b=this;var c=b.options;c.range=d;return this},getControl:function(){return this.$ctl},refresh:function(){var o=this;var l=o.options;var n=o.wrappedRange;var u=o.$content.text();var v=a(n.startContainer).parent();var m=a(n.endContainer).parent();var t=o.$content.children();var d=t.slice(0,t.index(v));var f=d.text().length+n.startOffset;var e=t.slice(0,t.index(m));var i=e.text().length+n.endOffset;var r=u.substr(f,(i-f));var w=a("<span />").addClass("text").css("visibility","hidden").text(u.substr(0,f)).appendTo(o.$overlay);var b=a("<span />").addClass("text").css("visibility","hidden").appendTo(o.$overlay);var p=/([\w’']+)(\W+)?/i;var q;while((q=p.exec(r))){a("<span />").text(q[1]).appendTo(b);if(q[2]){a("<span />").text(q[2]).appendTo(b)}r=r.substr(q[1].length+(q[2]?q[2].length:0))}var g=o.$content.offset();var s=[];var c;var k;b.children().each(function(){var x=a(this);var y=x.offset();if((!k)||(y.top!==k.top)){if(c){if((c.width<1)&&(c.height<1)){s.pop()}}c={top:y.top-g.top,left:y.left-g.left,width:x.width(),height:x.height()};s.push(c)}else{c.width+=x.width()}k=y});w.remove();b.remove();rangy.getSelection().removeAllRanges();o.element.empty();var j={top:99999,left:99999,bottom:0,right:0};a.each(s,function(){var x=this;j.top=Math.min(j.top,x.top);j.left=Math.min(j.left,x.left);j.bottom=Math.max(j.bottom,x.top+x.height);j.right=Math.max(j.right,x.left+x.width);x.top-=1;x.height+=2;x.left-=2;x.width+=4;a("<div />").addClass("text "+l.cssClass).css(x).data("contentOverlay-segment",x).appendTo(o.element)});l.extent=j;o.$segments=o.element.children();if(o.$ctl){var h=(o.$segments.length>0?o.$segments.position():o.element.position());h.top-=o.$ctl.height();o.$ctl.css(h)}},changeType:function(c){var b=this;var d=b.options;var e=a.ui.overlayGroup.types[c];if(e===undefined){return}b._setOption("cssClass",e.cssClass);b._setOption("template",e.template)},hitTest:function(i){var b=this;var g=b.options;var h=null;var c=b.element;b.$segments.each(function(){var k=a(this);var l=k.data("contentOverlay-segment");if(!l){return}var j=l.left+l.width;var e=l.top+l.height;if((i.offsetX>=l.left)&&(i.offsetX<=j)&&(i.offsetY>=l.top)&&(i.offsetY<=e)){h={type:"element",$el:k,$group:c};return false}});if(b.$ctl){if(h===null){var f=b.$ctl.offset();f.left-=2;f.top-=2;f.width=b.$ctl.width()+4;f.height=b.$ctl.height()+4;right=f.left+f.width;bottom=f.top+f.height;if((i.pageX>=f.left)&&(i.pageX<=right)&&(i.pageY>=f.top)&&(i.pageY<=bottom)){h={type:"control",$el:b.$ctl,$group:c}}}if(h!==null){if((i.type==="mousemove")||((h.type==="control")&&((i.type==="mousedown")||(i.type==="mouseup")))){i.preventDefault();i.stopPropagation();i.stopImmediatePropagation();if(!b.hovering){var d=b.lastEvent;if(d&&(Math.abs(d.pageX-i.pageX)<g.hoverDelta)&&(Math.abs(d.pageY-i.pageY)<g.hoverDelta)){b.hovering=true;b._trigger("hover-in")}}}else{if((h.type==="control")&&(i.type==="click")){b._trigger("action",null,i.target);i.preventDefault();i.stopPropagation();i.stopImmediatePropagation()}else{if(i.type==="click"){b.element.click();i.preventDefault();i.stopPropagation();i.stopImmediatePropagation()}}}b.lastEvent=i}else{if(b.hovering){b._trigger("hover-out");b.hovering=false}}}return h},_setOption:function(i,h){var l=this;var b=l.options;switch(i){case"cssClass":l.element.removeClass(b.cssClass).addClass(h);l.element.children().removeClass(b.cssClass).addClass(h);if(l.$ctl){l.$ctl.removeClass(b.cssClass).addClass(h)}break;case"template":if(l.$ctl){l.$ctl.remove()}var g=(l.$segments.length>0?l.$segments.position():l.element.position());l.$ctl=a(h).tmpl().addClass("overlay-controls "+b.cssClass).hide().appendTo(l.$content);g.top-=l.$ctl.height();l.$ctl.css(g);l.$ctl.data("contentOverlay-group",l.element);l.element.data("contentOverlay-control",l.$ctl);break;case"content":l.$content=a(h);if(l.$ctl){l.$ctl.appendTo(l.$content)}if((!l.wrappedRange)&&(b.range!==null)){var j,d;if(b.range instanceof rangy.WrappedRange){l.wrappedRange=b.range}else{if(typeof b.range==="string"){var k=/^([0-9\/]+:[0-9]+),([0-9\/]+:[0-9]+)$/;var c=range.match(k);j=c[1];d=c[2]}else{if(a.isPlainObject(b.range)){j=b.range.start;d=b.range.end}}}if(j&&d){var e=rangy.deserializePosition(j,l.$content[0]);var f=rangy.deserializePosition(d,l.$content[0]);l.wrappedRange=rangy.createRange();l.wrappedRange.setStart(e.node,e.offset);l.wrappedRange.setEnd(f.node,f.offset)}}if(l.wrappedRange){b.range={start:rangy.serializePosition(l.wrappedRange.startContainer,l.wrappedRange.startOffset,l.$content[0]),end:rangy.serializePosition(l.wrappedRange.endContainer,l.wrappedRange.endOffset,l.$content[0])}}l.refresh();break}a.Widget.prototype._setOption.apply(l,arguments)},_widgetInit:function(){var b=this;var c=b.options;b.element.addClass("group");b.$overlay=b.element.parent();if(c.cssClass){b._setOption("cssClass",c.cssClass)}if(c.content){b._setOption("content",c.content)}if(c.template){b._setOption("template",c.template)}return b},_widgetClean:function(){var b=this;var c=b.options;if(b.$ctl){b.$ctl.remove()}b.element.removeClass(c.cssClass).removeClass("group");return b},_eventsBind:function(){var b=this;var e=b.options;var d=function(h){var f=b.$ctl.height();var g=e.extent.top-f;b.$ctl.css("top",g).show()};var c=function(f){b.$ctl.hide()};b.element.bind("overlaygroup-hover-in.overlayGroup",d);b.element.bind("overlaygroup-hover-out.overlayGroup",c);return b},_eventsUnbind:function(){var b=this;return b}});a.ui.overlayGroup.types={selection:{cssClass:"selected",template:"#tmpl-overlay-controls"},tag:{cssClass:"tagged",template:"#tmpl-overlay-remove-controls"},}}(jQuery));(function(a){a.fn.summary=function(b){b=b||{};return this.each(function(){var c=a(this);c.data("summary",new a.Summary(c,b))})};a.Summary=function(c,b){return this.init(c,b)};a.Summary.prototype={options:{src:null,metadata:null,threshold:{min:-1,max:-1},filter:"normal",showSentences:5,rankOpacity:0.3,animSpeed:200},init:function(f,c){var b=this;var h=a.extend(true,{},b.options,c);b.element=f;b.options=h;b.metadata=null;b.state=[];var d=b.element.parent().parent();b.$control=d.find(".control-pane");b.$threshold=b.$control.find(".threshold");b.$thresholdValues=b.$threshold.find(".values");b.$buttons=b.$control.find(".buttons button").button();b.$filters=b.$control.find(".filter :checkbox");b.$control.find(".buttons .expansion").buttonset();var e=b.$filters.filter("#filter-tagged");var g=b.$filters.filter("#filter-starred");e.checkbox({cssOn:"su-icon su-icon-tag-blue",cssOff:"su-icon su-icon-tag",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});g.checkbox({cssOn:"su-icon su-icon-star-blue",cssOff:"su-icon su-icon-star",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});b.$control.show();b._bindEvents();b.element.addClass("loading");var i=a.get(h.metadata);i.success(function(j){b.metadata=j;b.render();b.element.removeClass("loading")});i.error(function(){alert("Cannot retrieve metadata '"+h.metadata+"'")})},destroy:function(){self._unbindEvents()},render:function(){var c=this;var d=c.options;if(c.metadata===null){return}c._noPut=true;var e=c._getState(d.metadata);if(e){d.threshold.min=e.threshold.min;d.threshold.max=e.threshold.max;d.filter=e.filter;c.state=(e.state?e.state:[])}c.renderXml(c.metadata);c.$p=c.element.find("p");c.$s=c.$p.find(".sentence");c.$kws=c.element.find(".keyword");c.ranks=[];c.$s.each(function(h){var g=a(this);var f=(c.state.length>h?c.state[h]:null);g.sentence(f);var i=g.sentence("option","rank");if(c.ranks[i]===undefined){c.ranks[i]=[]}c.ranks[i].push(g)});var b=d.threshold;if((d.threshold.min<0)||(d.threshold.max<0)){b=c._computeThreshold();c.origThreshold=b}c._changeFilter(d.filter,true);c.threshold(b.min,b.max);c._noPut=false},renderXml:function(d){var c=this;var f=c.options;var e=a(d);var b=a("<header />").appendTo(c.element);var h=e.find("document");var g=h.attr("src");if(g){f.src=g}h.children().each(function(){var l=a(this);switch(this.nodeName){case"title":var j=a("<h1 />");if(f.src!==null){var m=a("<a />").attr("href",f.src).text(l.text()).appendTo(j)}else{j.text(l.text())}b.append(j);break;case"published":var n=l.find("date").text()+" "+l.find("time").text();var i=new Date(n);var k=a("<time />").attr("datetime",i.toISOString()).attr("pubdate",true).text(n).appendTo(b);break;case"keywords":a("#tmpl-header-keywords").tmpl({keywords:l.find("keyword")}).appendTo(b);break;case"body":l.find("section").each(function(){var o=a("<section />").appendTo(c.element);a(this).find("p").each(function(){var p=a("<p />").appendTo(o);a(this).find("s").each(function(){var r=a(this);var u=parseFloat(r.attr("rank"));var t=(r.find("w:not([keyword])").length>0);if(isNaN(u)){u=0}u=parseInt(u*100,10);var q=a("#tmpl-sentence").tmpl({rank:u}).appendTo(p);var s=q.find(".content");q.attr("wordElements",t);q.find(".rank").css("opacity",f.rankOpacity);a.each(this.childNodes,function(){var v=a(this);switch(this.nodeName){case"#text":if(t===true){return}case"w":if(v.attr("keyword")){a("#tmpl-sentence-keyword").tmpl({keyword:v.attr("keyword"),text:v.text()}).appendTo(s)}else{a("#tmpl-sentence-text").tmpl({text:v.text()}).appendTo(s)}break;case"keyword":a("#tmpl-sentence-keyword").tmpl({keyword:v.attr("name"),text:v.text()}).appendTo(s);break}})})})});break;default:b.append(l);break}})},threshold:function(e,b){var d=this;var f=d.options;var c=(e<f.threshold.min);f.threshold.min=e;f.threshold.max=b;d.refresh(c)},refresh:function(e){var i=this;var b=i.options;var g=b.threshold.min+" - "+b.threshold.max;i.$thresholdValues.text(g);i.$s.addClass("noHighlight");if(b.filter==="normal"){for(var j=b.threshold.max;j>=b.threshold.min;j--){var d=i.ranks[j];if(d===undefined){continue}var c=d.length;for(var h=0;h<c;h++){var f=d[h];f.addClass("toHighlight").removeClass("noHighlight")}}}else{if(b.filter.indexOf("tagged")>=0){i.$s.filter(":has(.tagged)").addClass("toHighlight").removeClass("noHighlight")}if(b.filter.indexOf("starred")>=0){i.$s.filter(".starred").addClass("toHighlight").removeClass("noHighlight")}}i.$s.sentence("option","noExpansion",false);i.$p.each(function(){var l=a(this);var k=l.find(".sentence");if(k.length===1){k.sentence("option","noExpansion",true);return}k.each(function(){var m=a(this);var o=m.prev();var n=m.next();if(o.length<1){if(m.hasClass("noHighlight")||(n.length<1)||n.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}else{if(n.length<1){if(m.hasClass("noHighlight")||(o.length<1)||o.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}else{if(o.hasClass("toHighlight")&&n.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}}})});i.$s.filter(".noHighlight").removeClass("noHighlight").sentence("unhighlight").end().filter(".toHighlight").removeClass("toHighlight").sentence("highlight");i._putState()},_getState:function(c){var b=this;var d=b.options;if(c===undefined){c=d.metadata}return a.jStorage.get(c)},_putState:function(c){var b=this;var d=b.options;if(b._noPut===true){return}if(c===undefined){c=d.metadata}var e={threshold:d.threshold,filter:d.filter,state:b.state};a.jStorage.set(c,e)},_computeThreshold:function(){var d=this;var g=d.options;var e=0;var b={min:-1,max:100};for(var f=d.ranks.length-1;f>0;f--){var c=d.ranks[f];if(c===undefined){continue}e+=c.length;if(e>g.showSentences){b.min=Math.floor(f/10)*10;break}}return b},_changeFilter:function(d,g){var b=this;var f=b.options;var c=b.$control.find("[name=threshold-up],[name=threshold-down]");var e=(d?d.split(/\s*,\s*/):["normal"]);a.each(e,function(){switch(this.toString()){case"tagged":c.button("disable");break;case"starred":c.button("disable");break;case"normal":default:d="normal";c.button("enable");b.$filters.checkbox("uncheck");break}});f.filter=d;b.element.removeClass("starred tagged normal").addClass(e.join(" "));if(g!==true){b.refresh()}return b},_bindEvents:function(){var b=this;var d=b.options;var e=b.element.parent();var c=e.parent();c.delegate(".controls input, .controls button","click",function(){var g=a(this);var f=g.attr("name");var h=d.threshold.min;switch(f){case"threshold-all":d.threshold.min=0;b._changeFilter();break;case"threshold-reset":if(b.origThreshold===undefined){b.origThreshold=b._computeThreshold()}d.threshold.min=b.origThreshold.min;b.$s.removeClass("old-0 old-1 old-2 old-3 old-4 old-5 old-6 old-7 old-8").removeData("age");b._changeFilter();break;case"threshold-down":if(h>9){h-=10}b.threshold(h,d.threshold.max);break;case"threshold-up":if(h<(d.threshold.max-9)){h+=10}b.threshold(h,d.threshold.max);break}});c.delegate(".controls .filter","change",function(k,j){var g=a(this);var h=a(k.target);var f=h.attr("name");switch(f){case"filter":var i=b.$filters.map(function(){return a(this).checkbox("val")});b._changeFilter(a.makeArray(i).join(","));break}});c.delegateHoverIntent(".keyword",function(i){var h=a(this);if((i.type==="hover-in")&&h.hasClass("ui-state-highlight")){return}var f=h.attr("name");var g=b.$kws.filter("[name="+f+"]");switch(i.type){case"hover-out":g.removeClass("keyword-hover");break;case"hover-in":g.addClass("keyword-hover");break}});e.delegateHoverIntent(".rank",function(g){var f=a(this);switch(g.type){case"hover-out":b.$s.find(".rank").css("opacity",d.rankOpacity);g.stopPropagation();break;case"hover-in":b.$s.find(".rank").css("opacity",1);break}});e.delegate("p","click",function(j){var h=a(this);var k=a(j.target);var f;if((!k.is("p"))&&(!k.hasClass("sentence"))){k=k.parents(".sentence:first")}if(k.hasClass("sentence")){if(k.sentence("isVisible")){return}f=k}else{var g=h.find(".sentence");g.each(function(){var l=a(this);var m=l.offset();m.top-=2;m.left-=2;m.right=m.left+l.width()+4;m.bottom=m.top+l.height()+4;if((j.pageX>=m.left)&&(j.pageX<=m.right)&&(j.pageY>=m.top)&&(j.pageY<=m.bottom)){f=l;return false}});if((f===undefined)||(f.sentence("isVisible"))){return}}if(f.sentence("option","noExpansion")){var i=f.siblings(".highlight:first");if(i.length<1){i=f.siblings(":not(.hide-expand):first");if(i.length<1){f.sentence("option","noExpansion",false);i=f}}i.sentence("toggleOption","expanded")}else{f.sentence("toggleOption","expanded")}});e.delegate("header .keyword","click",function(){var h=a(this);var i=(!h.hasClass("ui-state-highlight"));var f=h.attr("name");var g=e.find("article p .keyword");var j=g.filter("[name="+f+"]");if(i){b.$s.filter(".highlight,.expansion").older(d);h.addClass("ui-state-highlight");j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.addClass("ui-state-highlight");k.addClass("keyworded",d.animSpeed)})}else{j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.removeClass("ui-state-highlight");var n=k.find(".keyword.ui-state-highlight").length;if(n<1){k.removeClass("keyworded",d.animSpeed)}});b.$s.filter('[class*=" old"]').younger(d);h.removeClass("ui-state-highlight")}});e.delegate(".sentence","sentence-change",function(i,h){var f=a(this);var g=b.$s.index(f);switch(h){case"highlighted":case"unhighlighted":case"expanded":case"collapsed":b.$s.slice(g+1).each(function(){a(this).sentence("syncNotePositions")});break;case"starred":case"unstarred":case"noteAdded":case"noteRemoved":case"commentAdded":case"commentRemoved":case"commentSaved":b.state[g]=f.sentence("serialize");b._putState();break}})},_unbindEvents:function(){var b=this;var d=b.element.parent();var c=d.parent();c.undelegate(".controls input, .controls button","click");d.undelegate("p","click");d.undelegateHoverIntent(".rank");d.undelegate("header .keyword","click");d.undelegate(".sentence","sentence-change")}};a.fn.older=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c>=0){c++}else{c=0}d.data("age",c);d.addClass("old-"+c,b.animSpeed)})};a.fn.younger=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c===undefined){c=0}d.removeClass("old-"+c,b.animSpeed);if(c>=0){c--}d.data("age",c)})}}(jQuery));(function(a){a.fn.summary=function(b){b=b||{};return this.each(function(){var c=a(this);c.data("summary",new a.Summary(c,b))})};a.Summary=function(c,b){return this.init(c,b)};a.Summary.prototype={options:{src:null,metadata:null,threshold:{min:-1,max:-1},filter:"normal",showSentences:5,rankOpacity:0.3,animSpeed:200},init:function(f,c){var b=this;var h=a.extend(true,{},b.options,c);b.element=f;b.options=h;b.metadata=null;b.state=[];var d=b.element.parent().parent();b.$control=d.find(".control-pane");b.$threshold=b.$control.find(".threshold");b.$thresholdValues=b.$threshold.find(".values");b.$buttons=b.$control.find(".buttons button").button();b.$filters=b.$control.find(".filter :checkbox");b.$control.find(".buttons .expansion").buttonset();var e=b.$filters.filter("#filter-tagged");var g=b.$filters.filter("#filter-starred");e.checkbox({cssOn:"su-icon su-icon-tag-blue",cssOff:"su-icon su-icon-tag",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});g.checkbox({cssOn:"su-icon su-icon-star-blue",cssOff:"su-icon su-icon-star",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});b.$control.show();b._bindEvents();b.element.addClass("loading");var i=a.get(h.metadata);i.success(function(j){b.metadata=j;b.render();b.element.removeClass("loading")});i.error(function(){alert("Cannot retrieve metadata '"+h.metadata+"'")})},destroy:function(){self._unbindEvents()},render:function(){var c=this;var d=c.options;if(c.metadata===null){return}c._noPut=true;var e=c._getState(d.metadata);if(e){d.threshold.min=e.threshold.min;d.threshold.max=e.threshold.max;d.filter=e.filter;c.state=(e.state?e.state:[])}c.renderXml(c.metadata);c.$p=c.element.find("p");c.$s=c.$p.find(".sentence");c.$kws=c.element.find(".keyword");c.ranks=[];c.$s.each(function(h){var g=a(this);var f=(c.state.length>h?c.state[h]:null);g.sentence(f);var i=g.sentence("option","rank");if(c.ranks[i]===undefined){c.ranks[i]=[]}c.ranks[i].push(g)});var b=d.threshold;if((d.threshold.min<0)||(d.threshold.max<0)){b=c._computeThreshold();c.origThreshold=b}c._changeFilter(d.filter,true);c.threshold(b.min,b.max);c._noPut=false},renderXml:function(d){var c=this;var f=c.options;var e=a(d);var b=a("<header />").appendTo(c.element);var h=e.find("document");var g=h.attr("src");if(g){f.src=g}h.children().each(function(){var l=a(this);switch(this.nodeName){case"title":var j=a("<h1 />");if(f.src!==null){var m=a("<a />").attr("href",f.src).text(l.text()).appendTo(j)}else{j.text(l.text())}b.append(j);break;case"published":var n=l.find("date").text()+" "+l.find("time").text();var i=new Date(n);var k=a("<time />").attr("datetime",i.toISOString()).attr("pubdate",true).text(n).appendTo(b);break;case"keywords":a("#tmpl-header-keywords").tmpl({keywords:l.find("keyword")}).appendTo(b);break;case"body":l.find("section").each(function(){var o=a("<section />").appendTo(c.element);a(this).find("p").each(function(){var p=a("<p />").appendTo(o);a(this).find("s").each(function(){var r=a(this);var u=parseFloat(r.attr("rank"));var t=(r.find("w:not([keyword])").length>0);if(isNaN(u)){u=0}u=parseInt(u*100,10);var q=a("#tmpl-sentence").tmpl({rank:u}).appendTo(p);var s=q.find(".content");q.attr("wordElements",t);q.find(".rank").css("opacity",f.rankOpacity);a.each(this.childNodes,function(){var v=a(this);switch(this.nodeName){case"#text":if(t===true){return}case"w":if(v.attr("keyword")){a("#tmpl-sentence-keyword").tmpl({keyword:v.attr("keyword"),text:v.text()}).appendTo(s)}else{a("#tmpl-sentence-text").tmpl({text:v.text()}).appendTo(s)}break;case"keyword":a("#tmpl-sentence-keyword").tmpl({keyword:v.attr("name"),text:v.text()}).appendTo(s);break}})})})});break;default:b.append(l);break}})},threshold:function(e,b){var d=this;var f=d.options;var c=(e<f.threshold.min);f.threshold.min=e;f.threshold.max=b;d.refresh(c)},refresh:function(e){var i=this;var b=i.options;var g=b.threshold.min+" - "+b.threshold.max;i.$thresholdValues.text(g);i.$s.addClass("noHighlight");if(b.filter==="normal"){for(var j=b.threshold.max;j>=b.threshold.min;j--){var d=i.ranks[j];if(d===undefined){continue}var c=d.length;for(var h=0;h<c;h++){var f=d[h];f.addClass("toHighlight").removeClass("noHighlight")}}}else{if(b.filter.indexOf("tagged")>=0){i.$s.filter(":has(.tagged)").addClass("toHighlight").removeClass("noHighlight")}if(b.filter.indexOf("starred")>=0){i.$s.filter(".starred").addClass("toHighlight").removeClass("noHighlight")}}i.$s.sentence("option","noExpansion",false);i.$p.each(function(){var l=a(this);var k=l.find(".sentence");if(k.length===1){k.sentence("option","noExpansion",true);return}k.each(function(){var m=a(this);var o=m.prev();var n=m.next();if(o.length<1){if(m.hasClass("noHighlight")||(n.length<1)||n.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}else{if(n.length<1){if(m.hasClass("noHighlight")||(o.length<1)||o.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}else{if(o.hasClass("toHighlight")&&n.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}}})});i.$s.filter(".noHighlight").removeClass("noHighlight").sentence("unhighlight").end().filter(".toHighlight").removeClass("toHighlight").sentence("highlight");i._putState()},_getState:function(c){var b=this;var d=b.options;if(c===undefined){c=d.metadata}return a.jStorage.get(c)},_putState:function(c){var b=this;var d=b.options;if(b._noPut===true){return}if(c===undefined){c=d.metadata}var e={threshold:d.threshold,filter:d.filter,state:b.state};a.jStorage.set(c,e)},_computeThreshold:function(){var d=this;var g=d.options;var e=0;var b={min:-1,max:100};for(var f=d.ranks.length-1;f>0;f--){var c=d.ranks[f];if(c===undefined){continue}e+=c.length;if(e>g.showSentences){b.min=Math.floor(f/10)*10;break}}return b},_changeFilter:function(d,g){var b=this;var f=b.options;var c=b.$control.find("[name=threshold-up],[name=threshold-down]");var e=(d?d.split(/\s*,\s*/):["normal"]);a.each(e,function(){switch(this.toString()){case"tagged":c.button("disable");break;case"starred":c.button("disable");break;case"normal":default:d="normal";c.button("enable");b.$filters.checkbox("uncheck");break}});f.filter=d;b.element.removeClass("starred tagged normal").addClass(e.join(" "));if(g!==true){b.refresh()}return b},_bindEvents:function(){var b=this;var d=b.options;var e=b.element.parent();var c=e.parent();c.delegate(".controls input, .controls button","click",function(){var g=a(this);var f=g.attr("name");var h=d.threshold.min;switch(f){case"threshold-all":d.threshold.min=0;b._changeFilter();break;case"threshold-reset":if(b.origThreshold===undefined){b.origThreshold=b._computeThreshold()}d.threshold.min=b.origThreshold.min;b.$s.removeClass("old-0 old-1 old-2 old-3 old-4 old-5 old-6 old-7 old-8").removeData("age");b._changeFilter();break;case"threshold-down":if(h>9){h-=10}b.threshold(h,d.threshold.max);break;case"threshold-up":if(h<(d.threshold.max-9)){h+=10}b.threshold(h,d.threshold.max);break}});c.delegate(".controls .filter","change",function(k,j){var g=a(this);var h=a(k.target);var f=h.attr("name");switch(f){case"filter":var i=b.$filters.map(function(){return a(this).checkbox("val")});b._changeFilter(a.makeArray(i).join(","));break}});c.delegateHoverIntent(".keyword",function(i){var h=a(this);if((i.type==="hover-in")&&h.hasClass("ui-state-highlight")){return}var f=h.attr("name");var g=b.$kws.filter("[name="+f+"]");switch(i.type){case"hover-out":g.removeClass("keyword-hover");break;case"hover-in":g.addClass("keyword-hover");break}});e.delegateHoverIntent(".rank",function(g){var f=a(this);switch(g.type){case"hover-out":b.$s.find(".rank").css("opacity",d.rankOpacity);g.stopPropagation();break;case"hover-in":b.$s.find(".rank").css("opacity",1);break}});e.delegate("p","click",function(j){var h=a(this);var k=a(j.target);var f;if((!k.is("p"))&&(!k.hasClass("sentence"))){k=k.parents(".sentence:first")}if(k.hasClass("sentence")){if(k.sentence("isVisible")){return}f=k}else{var g=h.find(".sentence");g.each(function(){var l=a(this);var m=l.offset();m.top-=2;m.left-=2;m.right=m.left+l.width()+4;m.bottom=m.top+l.height()+4;if((j.pageX>=m.left)&&(j.pageX<=m.right)&&(j.pageY>=m.top)&&(j.pageY<=m.bottom)){f=l;return false}});if((f===undefined)||(f.sentence("isVisible"))){return}}if(f.sentence("option","noExpansion")){var i=f.siblings(".highlight:first");if(i.length<1){i=f.siblings(":not(.hide-expand):first");if(i.length<1){f.sentence("option","noExpansion",false);i=f}}i.sentence("toggleOption","expanded")}else{f.sentence("toggleOption","expanded")}});e.delegate("header .keyword","click",function(){var h=a(this);var i=(!h.hasClass("ui-state-highlight"));var f=h.attr("name");var g=e.find("article p .keyword");var j=g.filter("[name="+f+"]");if(i){b.$s.filter(".highlight,.expansion").older(d);h.addClass("ui-state-highlight");j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.addClass("ui-state-highlight");k.addClass("keyworded",d.animSpeed)})}else{j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.removeClass("ui-state-highlight");var n=k.find(".keyword.ui-state-highlight").length;if(n<1){k.removeClass("keyworded",d.animSpeed)}});b.$s.filter('[class*=" old"]').younger(d);h.removeClass("ui-state-highlight")}});e.delegate(".sentence","sentence-change",function(i,h){var f=a(this);var g=b.$s.index(f);switch(h){case"highlighted":case"unhighlighted":case"expanded":case"collapsed":b.$s.slice(g+1).each(function(){a(this).sentence("syncNotePositions")});break;case"starred":case"unstarred":case"noteAdded":case"noteRemoved":case"commentAdded":case"commentRemoved":case"commentSaved":b.state[g]=f.sentence("serialize");b._putState();break}})},_unbindEvents:function(){var b=this;var d=b.element.parent();var c=d.parent();c.undelegate(".controls input, .controls button","click");d.undelegate("p","click");d.undelegateHoverIntent(".rank");d.undelegate("header .keyword","click");d.undelegate(".sentence","sentence-change")}};a.fn.older=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c>=0){c++}else{c=0}d.data("age",c);d.addClass("old-"+c,b.animSpeed)})};a.fn.younger=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c===undefined){c=0}d.removeClass("old-"+c,b.animSpeed);if(c>=0){c--}d.data("age",c)})}}(jQuery));