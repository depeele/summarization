(function(c){var b=null;var a=null;c.widget("ui.sentence",{version:"0.0.1",widgetEventPrefix:"sentence-",cssSelect:{cssClass:"selected",tagName:"em"},cssTag:{cssClass:"ui-state-default tagged",tagName:"em"},options:{notesPane:".notes-pane",rank:0,highlighted:false,expanded:false,starred:false,noExpansion:false,animSpeed:200,css:{highlighted:"highlight",expanded:"expanded",starred:"starred",noExpansion:"hide-expand"}},_init:function(){var d=this;var e=this.options;if(b===null){a=rangy.createCssClassApplier(d.cssTag.cssClass,{normalize:true,elementTagName:d.cssTag.tagName});b=rangy.createCssClassApplier(d.cssSelect.cssClass,{normalize:true,elementTagName:d.cssSelect.tagName})}e.enabled=d.element.attr("disabled")?false:true;if(e.rank<=0){var f=parseInt(d.element.attr("rank"),10);if(!isNaN(f)){e.rank=f}}d._widgetInit()._eventsBind()},isVisible:function(){return(this.element.filter(".highlight,.expanded,.expansion,.keyworded").length>0)},highlight:function(){this._setOption("highlighted",true)},unhighlight:function(){this._setOption("highlighted",false)},expand:function(){this._setOption("expanded",true)},collapse:function(){this._setOption("expanded",false)},star:function(d){this._setOption("starred",d)},addNotes:function(f,e){var d=this;var g=d.options;c.each(f,function(){if(!this){return}var h=new c.Notes(this);d._addNotes(h.getRange(),h,e)})},toggleOption:function(e){var d=this;var f=d.options;if(f[e]){d._setOption(e,false)}else{d._setOption(e,true)}},syncNotesPositions:function(){var e=this;var f=e.options;var d=e.element;var g=e.isVisible();d.find(".tagged").each(function(){var i=c(this);var h=i.data("notes-associate");if(!h){i.removeData("notes-associate");i.removeClass(f.css.tagged);return}h.notes((g?"show":"hide"))})},serializeNotes:function(){var d=this;var e=[];c.each(d.notes,function(){e.push(this.notes("serialize"))});return e},destroy:function(){this._eventsUnbind()._widgetClean()},_widgetInit:function(){var d=this;var e=d.options;d.notes=[];return d},_widgetClean:function(){var d=this;var e=d.options;return d},_setOption:function(e,g){var d=this;var f=d.options;switch(e){case"disabled":if(g){d._trigger("disabled")}else{d._trigger("enabled")}break;case"expanded":if(g){d._expand()}else{d._collapse()}break;case"highlighted":if(g){d._highlight()}else{d._unhighlight()}break;case"starred":d.widget()[g?"addClass":"removeClass"](f.css.starred);break;case"noExpansion":d.widget()[g?"addClass":"removeClass"](f.css.noExpansion);break}c.Widget.prototype._setOption.apply(d,arguments)},_highlight:function(){var e=this;var g=e.options;var d=e.element;if((g.highlighted===true)||(d.data("isHighlighting"))){return}var f=e.element.find(".controls .expand");var h=function(){d.css("display","").removeData("isHighlighting");e.syncNotesPositions();e._trigger("highlighted");e._trigger("change",null,"highlighted")};d.data("isHighlighting",true);d.addClass(g.css.highlighted,g.animSpeed,h)},_unhighlight:function(){var e=this;var f=e.options;var d=e.element;if((f.highlighted===false)||(d.data("isHighlighting"))){return}var g=function(){d.css("display","").removeData("isHighlighting");e.syncNotesPositions();e._trigger("unhighlighted");e._trigger("change",null,"unhighlighted")};d.data("isHighlighting",true);if(d.hasClass("highlighted")){d.removeClass(f.css.highlighted,f.animSpeed,g)}else{if(d.hasClass("expansion")){g()}}},_expand:function(){var g=this;var i=g.options;var d=g.element;if((i.expanded===true)||(d.data("isExpanding"))){return}var h=d.find(".controls .expand");var f=d.prev();var e=d.next();var j=function(){d.addClass("expansion").css("display","").removeData("isExpanding");h.attr("title","collapse");g.syncNotesPositions();g._trigger("expanded");g._trigger("change",null,"expanded")};d.data("isExpanding",true);d.addClass(i.css.expanded,i.animSpeed,j);if(!f.sentence("isVisible")){f.addClass("expansion",i.animSpeed,j)}if(!e.sentence("isVisible")){e.addClass("expansion",i.animSpeed,j)}},_collapse:function(){var l=this;var d=l.options;var j=l.element;if((d.expanded===false)||(j.data("isCollapsing"))){return}var e=j.find(".controls .expand");var f=j.prev();var i=j.next();var k=1;var g=function(){if(--k>0){return}j.removeClass("expansion").css("display","").removeData("isCollapsing");if(!j.hasClass("highlight")){j.removeClass("ui-hover").find(".controls .sui-icon").css("opacity","").end().find(".selection-controls").remove()}e.attr("title","expand");l.syncNotesPositions();l._trigger("collapsed");l._trigger("change",null,"collapsed")};var h=function(m){++k;m.removeClass("expansion",d.animSpeed,g);if(m.hasClass("expanded")){m.sentence("expanded",false)}};j.data("isCollapsing",true);if(j.hasClass(d.css.expanded)){j.removeClass(d.css.expanded,d.animSpeed,g)}else{if(j.hasClass("expansion")){j.removeClass("expansion",d.animSpeed,g)}}if(f.hasClass("expansion")){h(f)}if(i.hasClass("expansion")){h(i)}},_addNotes:function(l,o,n){var s=this;var d=s.options;var k;if((!o)||(!o instanceof c.Notes)){k=(o&&(o.id!==undefined)?o.id:s.notes.length);o={id:k,range:l}}else{k=o.getId()}var r=/^([0-9\/]+:[0-9]+),([0-9\/]+:[0-9]+)$/;var f=l.match(r);var q=f[1];var e=f[2];var g=rangy.deserializePosition(q,s.element.find(".content")[0]);var j=rangy.deserializePosition(e,s.element.find(".content")[0]);var i=rangy.createRange();var h=rangy.getSelection();i.setStart(g.node,g.offset);i.setEnd(j.node,j.offset);h.removeAllRanges();h.setSingleRange(i);a.applyToSelection();var f=h.getAllRanges();var p=c(f[0].startContainer).parent();f[0].getNodes([3],function(t){var u=c(t).parent();if(u.hasClass("tagged")){u.attr("name","summary-notes-"+k)}});h.removeAllRanges();var m=c("<div />").notes({notes:o,position:{of:p},hidden:(n?true:false)});s.notes[k]=m;p.data("summary-notes",m);m.data("notes-associate",p);p.data("notes-associate",m);s._trigger("change",null,"notesAdded")},_removeNotes:function(g){var e=this;var h=e.options;var d=g.data("summary-notes");if(!d){return}var j=d.notes("id");var f="summary-notes-"+j;var i=e.element.find("[name="+f+"]");d.removeData("tagged-item").notes("destroy");g.removeData("summary-notes");e.notes[j]=undefined;i.each(function(){var k=c(this);k.replaceWith(k.html())});e._trigger("change",null,"notesRemoved")},_generateRange:function(j){if(j===undefined){j=rangy.getSelection()}var g=this;var i=g.options;var d=g.element;var f=j.getAllRanges();var k=f[0];var e=f[f.length-1];var h={start:rangy.serializePosition(k.startContainer,k.startOffset,d.find(".content")[0]),end:rangy.serializePosition(e.endContainer,e.endOffset,d.find(".content")[0])};console.log("_generateRange: "+h.start+","+h.end);return h.start+","+h.end},_eventsBind:function(){var e=this;var d=e.element;var f=function(g){if(d.data("isCollapsing")||(!e.isVisible())){return}switch(g.type){case"mouseenter":d.addClass("ui-hover");break;case"mouseleave":d.removeClass("ui-hover");break}};d.hoverIntent(f);d.delegate(".controls .su-icon","mouseenter mouseleave",function(h){var g=c(this);switch(h.type){case"mouseenter":g.css("opacity",1);break;case"mouseleave":g.css("opacity","");break}});d.delegate(".controls .su-icon","click",function(i){var g=c(this);var h=false;if(g.hasClass("star")){e.toggleOption("starred");h=true}else{if(g.hasClass("expand")){e.toggleOption("expanded");h=true}}if(h){i.stopPropagation();return false}});d.delegate(".selection-controls .su-icon","mousedown mouseup",function(k){var i=c(k.target);var h=i.parents(".selection-controls:first");console.log("selection-controls "+k.type+": "+i.attr("class"));switch(k.type){case"mousedown":h.data("mousedown",true);break;case"mouseup":if(!h.data("mousedown")){return}var g=h.parent();h.removeData("mousedown").remove();if(i.hasClass("tag")){var j=rangy.getSelection();b.undoToSelection();range=e._generateRange(j);j.removeAllRanges();e._addNotes(range)}else{e._removeNotes(g)}break}k.preventDefault();k.stopPropagation();return false});d.bind("mouseup.ui-sentence",function(i){var g=c(i.target);var h=rangy.getSelection();var k=h.toString();d.find(".selection-controls").remove();d.find(".selected").each(function(){var l=c(this);if(l.hasClass("keyword")){l.removeClass("selected")}else{l.replaceWith(l.html())}});if(k.length<1){return}b.applyToSelection();var j=d.find(".selected:first");c("#tmpl-selection-controls").tmpl().appendTo(j).css({top:-22,left:0})});d.delegateHoverIntent(".tagged",function(l){var j=c(this);var i=j.attr("name");var k=e.element.find("[name="+i+"]:first");var h=k.data("notes-associate");switch(l.type){case"hover-in":e._ignoreHoverOut=false;c("#tmpl-selection-remove-controls").tmpl().appendTo(k).css({top:-22,left:0});if(h){h.notes("activate")}break;case"hover-out":if(h&&(e._ignoreHoverOut!==true)){h.notes("deactivate")}e._ignoreHoverOut=false;var g=j.parents(".sentence:first");g.find(".selection-controls").remove();break}});d.delegate(".tagged","click",function(k){var i=c(this);var h=i.attr("name");var j=e.element.find("[name="+h+"]:first");var g=j.data("notes-associate");g.notes("focus");e._ignoreHoverOut=true;return false});return e},_eventsUnbind:function(){var e=this;var d=e.element;e.element.unhoverIntent();d.undelegate(".controls .su-icon","mouseenter mouseleave");d.undelegate(".controls .su-icon","click");d.undelegate(".selection-controls .su-icon","mousedown mouseup");d.unbind(".ui-sentence");d.undelegateHoverIntent(".tagged");d.undelegate(".tagged","click");return e}})}(jQuery));(function(a){a.fn.summary=function(b){b=b||{};return this.each(function(){var c=a(this);c.data("summary",new a.Summary(c,b))})};a.Summary=function(c,b){return this.init(c,b)};a.Summary.prototype={options:{src:null,metadata:null,threshold:{min:-1,max:-1},filter:"normal",showSentences:5,rankOpacity:0.3,animSpeed:200},init:function(f,c){var b=this;var h=a.extend(true,{},b.options,c);b.element=f;b.options=h;b.metadata=null;b.starred=[];b.notes=[];var d=b.element.parent().parent();b.$control=d.find(".control-pane");b.$notes=d.find(".notes-pane");b.$threshold=b.$control.find(".threshold");b.$thresholdValues=b.$threshold.find(".values");b.$buttons=b.$control.find(".buttons button").button();b.$filters=b.$control.find(".filter :checkbox");b.$control.find(".buttons .expansion").buttonset();var e=b.$filters.filter("#filter-tagged");var g=b.$filters.filter("#filter-starred");e.checkbox({cssOn:"su-icon su-icon-tag-blue",cssOff:"su-icon su-icon-tag",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});g.checkbox({cssOn:"su-icon su-icon-star-blue",cssOff:"su-icon su-icon-star",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});b.$control.show();rangy.init();b.cssTag=rangy.createCssClassApplier("ui-state-default tagged",{normalize:true,elementTagName:"em"});b.cssSelect=rangy.createCssClassApplier("selected",{normalize:true,elementTagName:"em"});b._bindEvents();var i=a.get(h.metadata);b.element.addClass("loading");i.success(function(j){b.metadata=j;b.render();b.element.removeClass("loading")});i.error(function(){alert("Cannot retrieve metadata '"+h.metadata+"'")})},destroy:function(){self._unbindEvents()},render:function(){var d=this;var f=d.options;if(d.metadata===null){return}var g=d._getState(f.metadata);var e=[];if(g){f.threshold.min=g.threshold.min;f.threshold.max=g.threshold.max;f.filter=g.filter;d.starred=(g.starred?g.starred:[]);if(g.notes){e=g.notes}}d.renderXml(d.metadata);d.$p=d.element.find("p");d.$s=d.$p.find(".sentence").sentence();d.$kws=d.element.find(".keyword");d.ranks=[];d.$s.each(function(){var h=a(this);var i=h.sentence("option","rank");if(d.ranks[i]===undefined){d.ranks[i]=[]}d.ranks[i].push(h)});var b=f.threshold;if((f.threshold.min<0)||(f.threshold.max<0)){b=d._computeThreshold();d.origThreshold=b}if(d.starred.length>0){d.$s.removeClass("starred");a.each(d.starred,function(i,j){if(j===true){var h=a(d.$s.get(i));h.addClass("starred")}})}if(e.length>0){var c=e.length;d._noPut=true;a.each(e,function(i,j){if(!a.isArray(j)){return}var h=a(d.$s.get(i));h.sentence("addNotes",this,true)});d._noPut=false}d._changeFilter(f.filter,true);d.threshold(b.min,b.max)},renderXml:function(d){var c=this;var f=c.options;var e=a(d);var b=a("<header />").appendTo(c.element);var h=e.find("document");var g=h.attr("src");if(g){f.src=g}h.children().each(function(){var l=a(this);switch(this.nodeName){case"title":var j=a("<h1 />");if(f.src!==null){var m=a("<a />").attr("href",f.src).text(l.text()).appendTo(j)}else{j.text(l.text())}b.append(j);break;case"published":var n=l.find("date").text()+" "+l.find("time").text();var i=new Date(n);var k=a("<time />").attr("datetime",i.toISOString()).attr("pubdate",true).text(n).appendTo(b);break;case"keywords":a("#tmpl-header-keywords").tmpl({keywords:l.find("keyword")}).appendTo(b);break;case"body":l.find("section").each(function(){var o=a("<section />").appendTo(c.element);a(this).find("p").each(function(){var p=a("<p />").appendTo(o);a(this).find("s").each(function(){var r=a(this);var t=parseFloat(r.attr("rank"));if(isNaN(t)){t=0}t=parseInt(t*100,10);var q=a("#tmpl-sentence").tmpl({rank:t}).appendTo(p);var s=q.find(".content");q.find(".rank").css("opacity",f.rankOpacity);a.each(this.childNodes,function(){var u=a(this);switch(this.nodeName){case"w":case"#text":if(u.attr("keyword")){a("#tmpl-sentence-keyword").tmpl({keyword:u.attr("keyword"),text:u.text()}).appendTo(s)}else{a("#tmpl-sentence-text").tmpl({text:u.text()}).appendTo(s)}break;case"keyword":a("#tmpl-sentence-keyword").tmpl({keyword:u.attr("name"),text:u.text()}).appendTo(s);break}})})})});break;default:b.append(l);break}})},threshold:function(e,b){var d=this;var f=d.options;var c=(e<f.threshold.min);f.threshold.min=e;f.threshold.max=b;d.refresh(c)},refresh:function(e){var i=this;var b=i.options;var g=b.threshold.min+" - "+b.threshold.max;i.$thresholdValues.text(g);i.$s.addClass("noHighlight");if(b.filter==="normal"){for(var j=b.threshold.max;j>=b.threshold.min;j--){var d=i.ranks[j];if(d===undefined){continue}var c=d.length;for(var h=0;h<c;h++){var f=d[h];f.addClass("toHighlight").removeClass("noHighlight")}}}else{if(b.filter.indexOf("tagged")>=0){i.$s.filter(":has(.tagged)").addClass("toHighlight").removeClass("noHighlight")}if(b.filter.indexOf("starred")>=0){i.$s.filter(".starred").addClass("toHighlight").removeClass("noHighlight")}}i.$s.sentence("option","noExpansion",false);i.$p.each(function(){var l=a(this);var k=l.find(".sentence");if(k.length===1){k.sentence("option","noExpansion",true);return}k.each(function(){var m=a(this);var o=m.prev();var n=m.next();if(o.length<1){if(m.hasClass("noHighlight")||(n.length<1)||n.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}else{if(n.length<1){if(m.hasClass("noHighlight")||(o.length<1)||o.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}else{if(o.hasClass("toHighlight")&&n.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}}})});i.$s.filter(".noHighlight").removeClass("noHighlight").sentence("unhighlight").end().filter(".toHighlight").removeClass("toHighlight").sentence("highlight");i._putState()},_getState:function(c){var b=this;var d=b.options;if(c===undefined){c=d.metadata}return a.jStorage.get(c)},_putState:function(c){var b=this;var d=b.options;if(b._noPut===true){return}if(c===undefined){c=d.metadata}var e={threshold:d.threshold,filter:d.filter,starred:b.starred,notes:b.notes};a.jStorage.set(c,e)},_computeThreshold:function(){var d=this;var g=d.options;var e=0;var b={min:-1,max:100};for(var f=d.ranks.length-1;f>0;f--){var c=d.ranks[f];if(c===undefined){continue}e+=c.length;if(e>g.showSentences){b.min=Math.floor(f/10)*10;break}}return b},_starOn:function(b){var c=this;var e=c.options;var d=c.$s.index(b);b.addClass("starred");c.starred[d]=true;return this},_starOff:function(b){var c=this;var e=c.options;var d=c.$s.index(b);b.removeClass("starred");c.starred[d]=false;return this},_changeFilter:function(d,g){var b=this;var f=b.options;var c=b.$control.find("[name=threshold-up],[name=threshold-down]");var e=(d?d.split(/\s*,\s*/):["normal"]);a.each(e,function(){switch(this.toString()){case"tagged":c.button("disable");break;case"starred":c.button("disable");break;case"normal":default:d="normal";c.button("enable");b.$filters.checkbox("uncheck");break}});f.filter=d;b.element.removeClass("starred tagged normal").addClass(e.join(" "));if(g!==true){b.refresh()}return b},_removeNotes:function(e){var c=this;var f=c.options;var b=e.data("summary-notes");if(!b){return}var h=b.notes("id");var d="summary-notes-"+h;var g=c.element.find("[name="+d+"]");b.removeData("tagged-item").notes("destroy");e.removeData("summary-notes");c.notes[h]=undefined;g.each(function(){var i=a(this);i.replaceWith(i.html())});c._putState()},_bindEvents:function(){var b=this;var d=b.options;var e=b.element.parent();var c=e.parent();c.delegate(".controls input, .controls button","click",function(){var g=a(this);var f=g.attr("name");var h=d.threshold.min;switch(f){case"threshold-all":d.threshold.min=0;b._changeFilter();break;case"threshold-reset":if(b.origThreshold===undefined){b.origThreshold=b._computeThreshold()}d.threshold.min=b.origThreshold.min;b.$s.removeClass("old-0 old-1 old-2 old-3 old-4 old-5 old-6 old-7 old-8").removeData("age");b._changeFilter();break;case"threshold-down":if(h>9){h-=10}b.threshold(h,d.threshold.max);break;case"threshold-up":if(h<(d.threshold.max-9)){h+=10}b.threshold(h,d.threshold.max);break}});c.delegate(".controls .filter","change",function(k,j){var g=a(this);var h=a(k.target);var f=h.attr("name");switch(f){case"filter":var i=b.$filters.map(function(){return a(this).checkbox("val")});b._changeFilter(a.makeArray(i).join(","));break}});c.delegateHoverIntent(".keyword",function(i){var h=a(this);if((i.type==="hover-in")&&h.hasClass("ui-state-highlight")){return}var f=h.attr("name");var g=b.$kws.filter("[name="+f+"]");switch(i.type){case"hover-out":g.removeClass("keyword-hover");break;case"hover-in":g.addClass("keyword-hover");break}});e.delegateHoverIntent(".rank",function(g){var f=a(this);switch(g.type){case"hover-out":b.$s.find(".rank").css("opacity",d.rankOpacity);g.stopPropagation();break;case"hover-in":b.$s.find(".rank").css("opacity",1);break}});e.delegate("p","click",function(j){var h=a(this);var k=a(j.target);var f;if((!k.is("p"))&&(!k.hasClass("sentence"))){k=k.parents(".sentence:first")}if(k.hasClass("sentence")){if(k.sentence("isVisible")){return}f=k}else{var g=h.find(".sentence");g.each(function(){var l=a(this);var m=l.offset();m.top-=2;m.left-=2;m.right=m.left+l.width()+4;m.bottom=m.top+l.height()+4;if((j.pageX>=m.left)&&(j.pageX<=m.right)&&(j.pageY>=m.top)&&(j.pageY<=m.bottom)){f=l;return false}});if((f===undefined)||(f.sentence("isVisible"))){return}}if(f.sentence("option","noExpansion")){var i=f.siblings(".highlight:first");if(i.length<1){i=f.siblings(":not(.hide-expand):first");if(i.length<1){f.sentence("option","noExpansion",false);i=f}}i.sentence("toggleOption","expanded")}else{f.sentence("toggleOption","expanded")}});e.delegate("header .keyword","click",function(){var h=a(this);var i=(!h.hasClass("ui-state-highlight"));var f=h.attr("name");var g=e.find("article p .keyword");var j=g.filter("[name="+f+"]");if(i){b.$s.filter(".highlight,.expansion").older(d);h.addClass("ui-state-highlight");j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.addClass("ui-state-highlight");k.addClass("keyworded",d.animSpeed)})}else{j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.removeClass("ui-state-highlight");var n=k.find(".keyword.ui-state-highlight").length;if(n<1){k.removeClass("keyworded",d.animSpeed)}});b.$s.filter('[class*=" old"]').younger(d);h.removeClass("ui-state-highlight")}});e.delegate(".sentence","sentence-change",function(i,h){var f=a(this);var g=b.$s.index(f);switch(h){case"highlighted":case"unhighlighted":case"expanded":case"collapsed":b.$s.slice(g).sentence("syncNotesPositions");break;case"starred":b.starred[g]=true;break;case"unstarred":b.starred[g]=undefined;break;case"notesAdded":b.notes[g]=f.sentence("serializeNotes");break;case"notesRemoved":b.notes[g]=undefined;break}b._putState()});b.$notes.delegate(".notes","changed",function(){var g=a(this);var f=g.notes("notesCount");if(f<1){var h=g.data("notes-associate");b._removeNotes(h)}else{var i=g.notes("id");b.notes[i]=g.notes("serialize");b._putState()}})},_unbindEvents:function(){var b=this;var d=b.element.parent();var c=d.parent();c.undelegate(".controls input, .controls button","click");d.undelegate("p","click");d.undelegateHoverIntent(".rank");d.undelegate("header .keyword","click");d.undelegate(".sentence","sentence-change");b.$notes.undelegate(".notes","changed")}};a.fn.older=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c>=0){c++}else{c=0}d.data("age",c);d.addClass("old-"+c,b.animSpeed)})};a.fn.younger=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c===undefined){c=0}d.removeClass("old-"+c,b.animSpeed);if(c>=0){c--}d.data("age",c)})}}(jQuery));(function(a){a.fn.summary=function(b){b=b||{};return this.each(function(){var c=a(this);c.data("summary",new a.Summary(c,b))})};a.Summary=function(c,b){return this.init(c,b)};a.Summary.prototype={options:{src:null,metadata:null,threshold:{min:-1,max:-1},filter:"normal",showSentences:5,rankOpacity:0.3,animSpeed:200},init:function(f,c){var b=this;var h=a.extend(true,{},b.options,c);b.element=f;b.options=h;b.metadata=null;b.starred=[];b.notes=[];var d=b.element.parent().parent();b.$control=d.find(".control-pane");b.$notes=d.find(".notes-pane");b.$threshold=b.$control.find(".threshold");b.$thresholdValues=b.$threshold.find(".values");b.$buttons=b.$control.find(".buttons button").button();b.$filters=b.$control.find(".filter :checkbox");b.$control.find(".buttons .expansion").buttonset();var e=b.$filters.filter("#filter-tagged");var g=b.$filters.filter("#filter-starred");e.checkbox({cssOn:"su-icon su-icon-tag-blue",cssOff:"su-icon su-icon-tag",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});g.checkbox({cssOn:"su-icon su-icon-star-blue",cssOff:"su-icon su-icon-star",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});b.$control.show();rangy.init();b.cssTag=rangy.createCssClassApplier("ui-state-default tagged",{normalize:true,elementTagName:"em"});b.cssSelect=rangy.createCssClassApplier("selected",{normalize:true,elementTagName:"em"});b._bindEvents();var i=a.get(h.metadata);b.element.addClass("loading");i.success(function(j){b.metadata=j;b.render();b.element.removeClass("loading")});i.error(function(){alert("Cannot retrieve metadata '"+h.metadata+"'")})},destroy:function(){self._unbindEvents()},render:function(){var d=this;var f=d.options;if(d.metadata===null){return}var g=d._getState(f.metadata);var e=[];if(g){f.threshold.min=g.threshold.min;f.threshold.max=g.threshold.max;f.filter=g.filter;d.starred=(g.starred?g.starred:[]);if(g.notes){e=g.notes}}d.renderXml(d.metadata);d.$p=d.element.find("p");d.$s=d.$p.find(".sentence").sentence();d.$kws=d.element.find(".keyword");d.ranks=[];d.$s.each(function(){var h=a(this);var i=h.sentence("option","rank");if(d.ranks[i]===undefined){d.ranks[i]=[]}d.ranks[i].push(h)});var b=f.threshold;if((f.threshold.min<0)||(f.threshold.max<0)){b=d._computeThreshold();d.origThreshold=b}if(d.starred.length>0){d.$s.removeClass("starred");a.each(d.starred,function(i,j){if(j===true){var h=a(d.$s.get(i));h.addClass("starred")}})}if(e.length>0){var c=e.length;d._noPut=true;a.each(e,function(i,j){if(!a.isArray(j)){return}var h=a(d.$s.get(i));h.sentence("addNotes",this,true)});d._noPut=false}d._changeFilter(f.filter,true);d.threshold(b.min,b.max)},renderXml:function(d){var c=this;var f=c.options;var e=a(d);var b=a("<header />").appendTo(c.element);var h=e.find("document");var g=h.attr("src");if(g){f.src=g}h.children().each(function(){var l=a(this);switch(this.nodeName){case"title":var j=a("<h1 />");if(f.src!==null){var m=a("<a />").attr("href",f.src).text(l.text()).appendTo(j)}else{j.text(l.text())}b.append(j);break;case"published":var n=l.find("date").text()+" "+l.find("time").text();var i=new Date(n);var k=a("<time />").attr("datetime",i.toISOString()).attr("pubdate",true).text(n).appendTo(b);break;case"keywords":a("#tmpl-header-keywords").tmpl({keywords:l.find("keyword")}).appendTo(b);break;case"body":l.find("section").each(function(){var o=a("<section />").appendTo(c.element);a(this).find("p").each(function(){var p=a("<p />").appendTo(o);a(this).find("s").each(function(){var r=a(this);var t=parseFloat(r.attr("rank"));if(isNaN(t)){t=0}t=parseInt(t*100,10);var q=a("#tmpl-sentence").tmpl({rank:t}).appendTo(p);var s=q.find(".content");q.find(".rank").css("opacity",f.rankOpacity);a.each(this.childNodes,function(){var u=a(this);switch(this.nodeName){case"w":case"#text":if(u.attr("keyword")){a("#tmpl-sentence-keyword").tmpl({keyword:u.attr("keyword"),text:u.text()}).appendTo(s)}else{a("#tmpl-sentence-text").tmpl({text:u.text()}).appendTo(s)}break;case"keyword":a("#tmpl-sentence-keyword").tmpl({keyword:u.attr("name"),text:u.text()}).appendTo(s);break}})})})});break;default:b.append(l);break}})},threshold:function(e,b){var d=this;var f=d.options;var c=(e<f.threshold.min);f.threshold.min=e;f.threshold.max=b;d.refresh(c)},refresh:function(e){var i=this;var b=i.options;var g=b.threshold.min+" - "+b.threshold.max;i.$thresholdValues.text(g);i.$s.addClass("noHighlight");if(b.filter==="normal"){for(var j=b.threshold.max;j>=b.threshold.min;j--){var d=i.ranks[j];if(d===undefined){continue}var c=d.length;for(var h=0;h<c;h++){var f=d[h];f.addClass("toHighlight").removeClass("noHighlight")}}}else{if(b.filter.indexOf("tagged")>=0){i.$s.filter(":has(.tagged)").addClass("toHighlight").removeClass("noHighlight")}if(b.filter.indexOf("starred")>=0){i.$s.filter(".starred").addClass("toHighlight").removeClass("noHighlight")}}i.$s.sentence("option","noExpansion",false);i.$p.each(function(){var l=a(this);var k=l.find(".sentence");if(k.length===1){k.sentence("option","noExpansion",true);return}k.each(function(){var m=a(this);var o=m.prev();var n=m.next();if(o.length<1){if(m.hasClass("noHighlight")||(n.length<1)||n.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}else{if(n.length<1){if(m.hasClass("noHighlight")||(o.length<1)||o.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}else{if(o.hasClass("toHighlight")&&n.hasClass("toHighlight")){m.sentence("option","noExpansion",true)}}}})});i.$s.filter(".noHighlight").removeClass("noHighlight").sentence("unhighlight").end().filter(".toHighlight").removeClass("toHighlight").sentence("highlight");i._putState()},_getState:function(c){var b=this;var d=b.options;if(c===undefined){c=d.metadata}return a.jStorage.get(c)},_putState:function(c){var b=this;var d=b.options;if(b._noPut===true){return}if(c===undefined){c=d.metadata}var e={threshold:d.threshold,filter:d.filter,starred:b.starred,notes:b.notes};a.jStorage.set(c,e)},_computeThreshold:function(){var d=this;var g=d.options;var e=0;var b={min:-1,max:100};for(var f=d.ranks.length-1;f>0;f--){var c=d.ranks[f];if(c===undefined){continue}e+=c.length;if(e>g.showSentences){b.min=Math.floor(f/10)*10;break}}return b},_starOn:function(b){var c=this;var e=c.options;var d=c.$s.index(b);b.addClass("starred");c.starred[d]=true;return this},_starOff:function(b){var c=this;var e=c.options;var d=c.$s.index(b);b.removeClass("starred");c.starred[d]=false;return this},_changeFilter:function(d,g){var b=this;var f=b.options;var c=b.$control.find("[name=threshold-up],[name=threshold-down]");var e=(d?d.split(/\s*,\s*/):["normal"]);a.each(e,function(){switch(this.toString()){case"tagged":c.button("disable");break;case"starred":c.button("disable");break;case"normal":default:d="normal";c.button("enable");b.$filters.checkbox("uncheck");break}});f.filter=d;b.element.removeClass("starred tagged normal").addClass(e.join(" "));if(g!==true){b.refresh()}return b},_removeNotes:function(e){var c=this;var f=c.options;var b=e.data("summary-notes");if(!b){return}var h=b.notes("id");var d="summary-notes-"+h;var g=c.element.find("[name="+d+"]");b.removeData("tagged-item").notes("destroy");e.removeData("summary-notes");c.notes[h]=undefined;g.each(function(){var i=a(this);i.replaceWith(i.html())});c._putState()},_bindEvents:function(){var b=this;var d=b.options;var e=b.element.parent();var c=e.parent();c.delegate(".controls input, .controls button","click",function(){var g=a(this);var f=g.attr("name");var h=d.threshold.min;switch(f){case"threshold-all":d.threshold.min=0;b._changeFilter();break;case"threshold-reset":if(b.origThreshold===undefined){b.origThreshold=b._computeThreshold()}d.threshold.min=b.origThreshold.min;b.$s.removeClass("old-0 old-1 old-2 old-3 old-4 old-5 old-6 old-7 old-8").removeData("age");b._changeFilter();break;case"threshold-down":if(h>9){h-=10}b.threshold(h,d.threshold.max);break;case"threshold-up":if(h<(d.threshold.max-9)){h+=10}b.threshold(h,d.threshold.max);break}});c.delegate(".controls .filter","change",function(k,j){var g=a(this);var h=a(k.target);var f=h.attr("name");switch(f){case"filter":var i=b.$filters.map(function(){return a(this).checkbox("val")});b._changeFilter(a.makeArray(i).join(","));break}});c.delegateHoverIntent(".keyword",function(i){var h=a(this);if((i.type==="hover-in")&&h.hasClass("ui-state-highlight")){return}var f=h.attr("name");var g=b.$kws.filter("[name="+f+"]");switch(i.type){case"hover-out":g.removeClass("keyword-hover");break;case"hover-in":g.addClass("keyword-hover");break}});e.delegateHoverIntent(".rank",function(g){var f=a(this);switch(g.type){case"hover-out":b.$s.find(".rank").css("opacity",d.rankOpacity);g.stopPropagation();break;case"hover-in":b.$s.find(".rank").css("opacity",1);break}});e.delegate("p","click",function(j){var h=a(this);var k=a(j.target);var f;if((!k.is("p"))&&(!k.hasClass("sentence"))){k=k.parents(".sentence:first")}if(k.hasClass("sentence")){if(k.sentence("isVisible")){return}f=k}else{var g=h.find(".sentence");g.each(function(){var l=a(this);var m=l.offset();m.top-=2;m.left-=2;m.right=m.left+l.width()+4;m.bottom=m.top+l.height()+4;if((j.pageX>=m.left)&&(j.pageX<=m.right)&&(j.pageY>=m.top)&&(j.pageY<=m.bottom)){f=l;return false}});if((f===undefined)||(f.sentence("isVisible"))){return}}if(f.sentence("option","noExpansion")){var i=f.siblings(".highlight:first");if(i.length<1){i=f.siblings(":not(.hide-expand):first");if(i.length<1){f.sentence("option","noExpansion",false);i=f}}i.sentence("toggleOption","expanded")}else{f.sentence("toggleOption","expanded")}});e.delegate("header .keyword","click",function(){var h=a(this);var i=(!h.hasClass("ui-state-highlight"));var f=h.attr("name");var g=e.find("article p .keyword");var j=g.filter("[name="+f+"]");if(i){b.$s.filter(".highlight,.expansion").older(d);h.addClass("ui-state-highlight");j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.addClass("ui-state-highlight");k.addClass("keyworded",d.animSpeed)})}else{j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.removeClass("ui-state-highlight");var n=k.find(".keyword.ui-state-highlight").length;if(n<1){k.removeClass("keyworded",d.animSpeed)}});b.$s.filter('[class*=" old"]').younger(d);h.removeClass("ui-state-highlight")}});e.delegate(".sentence","sentence-change",function(i,h){var f=a(this);var g=b.$s.index(f);switch(h){case"highlighted":case"unhighlighted":case"expanded":case"collapsed":b.$s.slice(g).sentence("syncNotesPositions");break;case"starred":b.starred[g]=true;break;case"unstarred":b.starred[g]=undefined;break;case"notesAdded":b.notes[g]=f.sentence("serializeNotes");break;case"notesRemoved":b.notes[g]=undefined;break}b._putState()});b.$notes.delegate(".notes","changed",function(){var g=a(this);var f=g.notes("notesCount");if(f<1){var h=g.data("notes-associate");b._removeNotes(h)}else{var i=g.notes("id");b.notes[i]=g.notes("serialize");b._putState()}})},_unbindEvents:function(){var b=this;var d=b.element.parent();var c=d.parent();c.undelegate(".controls input, .controls button","click");d.undelegate("p","click");d.undelegateHoverIntent(".rank");d.undelegate("header .keyword","click");d.undelegate(".sentence","sentence-change");b.$notes.undelegate(".notes","changed")}};a.fn.older=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c>=0){c++}else{c=0}d.data("age",c);d.addClass("old-"+c,b.animSpeed)})};a.fn.younger=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c===undefined){c=0}d.removeClass("old-"+c,b.animSpeed);if(c>=0){c--}d.data("age",c)})}}(jQuery));