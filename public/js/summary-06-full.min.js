(function(a){a.Note=function(b){var c={author:null,text:"",created:new Date()};return this.init(a.extend(c,true,b||{}))};a.Note.prototype={init:function(b){this.props=b;if((this.props.author===null)||(a.isPlainObject(this.props.author))){this.props.author=new a.User(this.props.author)}return this},getAuthor:function(){return this.props.author},getText:function(){return this.props.text},getCreated:function(){return this.props.created},setText:function(b){this.props.text=b},serialize:function(){var b={author:(this.props.author?this.props.author.serialize():null),text:this.props.text,created:this.props.created};return b},destroy:function(){var b=this;var c=b.props;if(c.author&&(c.author instanceof a.User)){c.author.destroy()}delete c.author;delete c.text;delete c.created}};a.Notes=function(b){var c={id:null,range:null,notes:[],tags:[]};return this.init(a.extend(c,true,b||{}))};a.Notes.prototype={init:function(c){this.props=c;var b=[];a.each(this.props.notes,function(){var d=this;if(a.isPlainObject(d)){d=new a.Note(d)}b.push(d)});if(b.length<1){b.push(new a.Note())}this.props.notes=b;return this},addNote:function(b){if(a.isPlainObject(b)){b=new a.Note(b)}this.props.notes.push(b);return b},removeNote:function(c){var b=this;if(c instanceof a.Note){var d=-1;a.each(b.props.notes,function(e){if(this===c){d=e;return false}});if(d>=0){b.props.notes.splice(d,1);c.destroy()}}return b},getId:function(){return this.props.id},getRange:function(){return this.props.range},getNotes:function(){return this.props.notes},getNotesCount:function(){return this.props.notes.length},getTags:function(){return this.props.tags},getNote:function(b){b=b||0;return this.props.notes[b]},getTag:function(b){b=b||0;return this.props.tags[b]},serialize:function(){var b={id:this.props.id,range:this.props.range,notes:[],tags:this.props.tags};a.each(this.props.notes,function(){b.notes.push(this.serialize())});return b},destroy:function(){var b=this;var c=b.props;if(a.isArray(c.notes)){a.each(c.notes,function(){this.destroy()})}delete c.range;delete c.notes;delete c.tags}}}(jQuery));(function(a){a.widget("ui.notes",{version:"0.0.1",widgetEventPrefix:"notes-",options:{notes:null,container:".notes-pane",position:{my:"top",at:"top",of:null,using:null},animSpeed:200,hidden:false,template:"#tmpl-notes"},_init:function(){var b=this;var c=b.options;b._isInitializing=true;b.$container=a(c.container);if(a.isPlainObject(c.notes)){if((c.notes.id===undefined)||(c.notes.id===null)){c.notes.id=b.element.attr("id")}c.notes=new a.Notes(c.notes)}b._widgetCreate()._bindEvents();b._isInitializing=false;return b},id:function(){var b=this;var c=b.options;return c.notes.getId()},notesCount:function(){var b=this;var c=b.options;return c.notes.getNotesCount()},addNote:function(d){var c=this;var e=c.options;var b=a("<div />").note({note:d});c.$body.append(b);if(c._isInitializing!==true){var d=b.note("option","note");e.notes.addNote(d);c._trigger("change",null,"noteAdded")}return c},removeNote:function(b){var c=this;var e=c.options;var d=b.note("option","note");e.notes.removeNote(d);c._trigger("change",null,"noteRemoved");return c},activate:function(){var c=this;var d=c.options;if(c.element.hasClass("notes-active")){return}var b=c.$buttons.filter("[name=reply]");if((!c.$reply.hasClass("hint"))&&(c.$reply.val().length>0)){c.$buttons.show();b.button("enable")}else{c.$buttons.hide();b.button("disable");c.$reply.addClass("hint").val(c.$reply.attr("title"))}c.element.addClass("notes-active",d.animSpeed,function(){})},deactivate:function(){var b=this;var c=b.options;if(!b.element.hasClass("notes-active")){return}b.element.find(".note .buttons [name=cancel]").click();b.element.removeClass("notes-active",c.animSpeed)},show:function(){var b=this;var c=b.options;b.element.fadeIn(c.animSpeed).position(c.position)},hide:function(b){var c=this;var d=c.options;c.element.fadeOut(d.animSpeed,b)},focus:function(){var b=this;var c=b.options;b.$reply.trigger("focus")},serialize:function(){var b=this;var c=b.options;return c.notes.serialize()},destroy:function(){var b=this;var c=b.options;b._unbindEvents().hide(function(){b._widgetDestroy();c.notes.destroy()})},_widgetCreate:function(){var b=this;var c=b.options;if(c.position.using===null){c.position.using=function(d){a(this).animate({top:d.top},c.animSpeed)}}b.element.addClass("notes ui-corner-all").append(a(c.template).tmpl()).appendTo(b.$container);if(c.hidden===true){b.element.hide()}else{b.element.position(c.position)}b.$body=b.element.find(".notes-body");b.$reply=b.element.find(".notes-reply");b.$buttons=b.element.find(".notes-input-pane .buttons button");b.$buttons.button();a.each(c.notes.getNotes(),function(){b.addNote(this,true)});return b},_widgetDestroy:function(){var b=this;var c=b.options;b.$body.find(".note").note("destroy");b.$buttons.button("destroy");b.element.empty();return b},_bindEvents:function(){var b=this;var c=b.options;b._docClick=function(f){var d=a(f.target);if(d!==b.element){b.deactivate()}};a(document).bind("click.ui-notes",b._docClick);b.element.delegate(".notes-input-pane button","click.ui-notes",function(g){var f=a(this);switch(f.attr("name")){case"reply":var d=new a.Note({text:b.$reply.val()});b.addNote(d);b.$reply.val("");break;case"cancel":b.$reply.val("");b.$reply.blur();break}});b.$reply.bind("keyup.ui-notes",function(f){var d=b.$buttons.filter("[name=reply]");if((!b.$reply.hasClass("hint"))&&(b.$reply.val().length>0)){d.button("enable")}else{d.button("disable")}});b.element.bind("click.ui-notes",function(d){b.activate();return false});b.element.delegate(".note","note-destroyed",function(g,f){var d=a(g.target);b.removeNote(d)});b.$reply.bind("focus",function(f){b.$buttons.show();var d=b.$buttons.filter("[name=reply]");if(b.$reply.hasClass("hint")){b.$reply.val("").removeClass("hint")}if(b.$reply.val().length>0){d.button("enable")}else{d.button("disable")}});b.$reply.bind("blur",function(f){var d=b.$buttons.filter("[name=reply]");if(b.$reply.val().length>0){d.button("enable")}else{b.$reply.addClass("hint").val(b.$reply.attr("title"));b.$buttons.hide();d.button("disable")}});return b},_unbindEvents:function(){var b=this;var c=b.options;b.element.unbind(".ui-notes");b.element.undelegate(".notes-input-pane button",".ui-notes");b.$reply.unbind(".ui-notes");a(document).unbind("click.ui-notes",b._docClick);return b}});a.widget("ui.note",{version:"0.0.1",widgetEventPrefix:"note-",options:{note:null,template:"#tmpl-note"},serialize:function(){var b=this;var c=b.options;return c.note.serialize()},destroy:function(){var b=this;var c=b.options;b._unbindEvents()._widgetDestroy();b._trigger("destroyed",null,c.note)},_init:function(){var b=this;var c=b.options;if(a.isPlainObject(c.note)){c.note=new a.Notes(c.notes)}b._widgetCreate()._bindEvents();return b},_widgetCreate:function(){var b=this;var c=b.options;b.element.addClass("note").append(a(c.template).tmpl({note:c.note}));b.$comment=b.element.find(".comment");b.$editArea=b.element.find(".edit");b.$edit=b.$editArea.find("textarea");b.$buttons=b.element.find(".buttons button");b.$mainButtons=b.element.find(".buttons:last");b.$buttons.button();return b},_widgetDestroy:function(){var b=this;var c=b.options;b.$buttons.button("destroy");b.element.empty();return b},_bindEvents:function(){var b=this;var c=b.options;b.$buttons.bind("click.ui-note",function(f){var d=a(this);switch(d.attr("name")){case"edit":b.$edit.val(b.$comment.text());b.$comment.hide();b.$mainButtons.css("display","none");b.$editArea.show();b.$edit.focus();break;case"delete":b.element.slideUp(function(){b.element.remove()});break;case"save":c.note.setText(b.$edit.val());b.$comment.text(c.note.getText());b._trigger("change",null,"noteSaved");case"cancel":b.$editArea.hide();b.$comment.show();b.$mainButtons.css("display","");break}});return b},_unbindEvents:function(){var b=this;var c=b.options;b.$buttons.unbind(".ui-note");return b}})}(jQuery));(function(a){a.fn.summary=function(b){b=b||{};return this.each(function(){var c=a(this);c.data("summary",new a.Summary(c,b))})};a.Summary=function(c,b){return this.init(c,b)};a.Summary.prototype={options:{src:null,metadata:null,threshold:{min:-1,max:-1},filter:"normal",showSentences:5,lineHeight:-1,useColor:false,rankOpacity:0.3,animSpeed:200},init:function(f,c){var b=this;var h=a.extend(true,{},b.options,c);b.element=f;b.options=h;b.metadata=null;b.starred=[];b.notes=[];var d=b.element.parent().parent();b.$control=d.find(".control-pane");b.$notes=d.find(".notes-pane");b.$threshold=b.$control.find(".threshold");b.$thresholdValues=b.$threshold.find(".values");b.$buttons=b.$control.find(".buttons button").button();b.$filters=b.$control.find(".filter :checkbox");b.$control.find(".buttons .expansion").buttonset();var e=b.$filters.filter("#filter-tagged");var g=b.$filters.filter("#filter-starred");e.checkbox({cssOn:"su-icon su-icon-tag-blue",cssOff:"su-icon su-icon-tag",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});g.checkbox({cssOn:"su-icon su-icon-star-blue",cssOff:"su-icon su-icon-star",titleOn:"click to remove filter",titleOff:"click to filter",hideLabel:true});b.$control.show();rangy.init();b.cssTag=rangy.createCssClassApplier("ui-state-default tagged",{normalize:true,elementTagName:"em"});b.cssSelect=rangy.createCssClassApplier("selected",{normalize:true,elementTagName:"em"});b._bindEvents();var i=a.get(h.metadata);b.element.addClass("loading");i.success(function(j){b.metadata=j;b.render();b.element.removeClass("loading")});i.error(function(){alert("Cannot retrieve metadata '"+h.metadata+"'")})},destroy:function(){self._unbindEvents()},render:function(){var j=this;var b=j.options;if(j.metadata===null){return}var c=j._getState(b.metadata);var h=[];if(c){b.threshold.min=c.threshold.min;b.threshold.max=c.threshold.max;b.filter=c.filter;j.starred=(c.starred?c.starred:[]);if(c.notes){h=c.notes}}j.renderXml(j.metadata);j.$p=j.element.find("p");j.$s=j.$p.find(".sentence");j.$kws=j.element.find(".keyword");j.ranks=[];j.$s.each(function(){var n=a(this);var r=parseInt(n.attr("rank"),10);if(isNaN(r)){return}if(j.ranks[r]===undefined){j.ranks[r]=[]}if(b.useColor!==false){var p=(b.useColor===true?221:b.useColor);var q=p-Math.ceil(p*(r/100));var o=q;var l=q;var m="rgb("+q+","+o+","+l+")";n.css({color:m})}j.ranks[r].push(n)});var g=b.threshold;if((b.threshold.min<0)||(b.threshold.max<0)){g=j._computeThreshold();j.origThreshold=g}if(j.starred.length>0){j.$s.removeClass("starred");a.each(j.starred,function(m,n){if(n===true){var l=a(j.$s.get(m));l.addClass("starred")}})}if(h.length>0){var e=h.length;j._noPut=true;for(var k=0;k<e;k++){var d=h[k];if(!d){continue}var f=new a.Notes(d);var i=j._addNotes(f.getRange(),f,true)}j._noPut=false}j._changeFilter(b.filter,true);j.threshold(g.min,g.max)},renderXml:function(d){var c=this;var f=c.options;var e=a(d);var b=a("<header />").appendTo(c.element);var h=e.find("document");var g=h.attr("src");if(g){f.src=g}h.children().each(function(){var l=a(this);switch(this.nodeName){case"title":var j=a("<h1 />");if(f.src!==null){var m=a("<a />").attr("href",f.src).text(l.text()).appendTo(j)}else{j.text(l.text())}b.append(j);break;case"published":var n=l.find("date").text()+" "+l.find("time").text();var i=new Date(n);var k=a("<time />").attr("datetime",i.toISOString()).attr("pubdate",true).text(n).appendTo(b);break;case"keywords":a("#tmpl-header-keywords").tmpl({keywords:l.find("keyword")}).appendTo(b);break;case"body":l.find("section").each(function(){var o=a("<section />").appendTo(c.element);a(this).find("p").each(function(){var p=a("<p />").appendTo(o);a(this).find("s").each(function(){var r=a(this);var t=parseFloat(r.attr("rank"));if(isNaN(t)){t=0}t=parseInt(t*100,10);var q=a("#tmpl-sentence").tmpl({rank:t}).appendTo(p);var s=q.find(".content");q.find(".rank").css("opacity",f.rankOpacity);a.each(this.childNodes,function(){var u=a(this);switch(this.nodeName){case"w":case"#text":if(u.attr("keyword")){a("#tmpl-sentence-keyword").tmpl({keyword:u.attr("keyword"),text:u.text()}).appendTo(s)}else{a("#tmpl-sentence-text").tmpl({text:u.text()}).appendTo(s)}break;case"keyword":a("#tmpl-sentence-keyword").tmpl({keyword:u.attr("name"),text:u.text()}).appendTo(s);break}});if(f.lineHeight<1){f.lineHeight=q.height()}})})});break;default:b.append(l);break}})},threshold:function(e,b){var d=this;var f=d.options;var c=(e<f.threshold.min);f.threshold.min=e;f.threshold.max=b;d.refresh(c)},refresh:function(e){var i=this;var b=i.options;var g=b.threshold.min+" - "+b.threshold.max;i.$thresholdValues.text(g);i.$s.addClass("noHighlight");if(b.filter==="normal"){for(var j=b.threshold.max;j>=b.threshold.min;j--){var d=i.ranks[j];if(d===undefined){continue}var c=d.length;for(var h=0;h<c;h++){var f=d[h];f.addClass("toHighlight").removeClass("noHighlight")}}}else{if(b.filter.indexOf("tagged")>=0){i.$s.filter(":has(.tagged)").addClass("toHighlight").removeClass("noHighlight")}if(b.filter.indexOf("starred")>=0){i.$s.filter(".starred").addClass("toHighlight").removeClass("noHighlight")}}i.$s.removeClass("hide-expand");i.$p.each(function(){var l=a(this);var k=l.find(".sentence");if(k.length===1){k.addClass("hide-expand");return}k.each(function(){var m=a(this);var o=m.prev();var n=m.next();if(o.length<1){if(m.hasClass("noHighlight")||(n.length<1)||n.hasClass("toHighlight")){m.addClass("hide-expand")}}else{if(n.length<1){if(m.hasClass("noHighlight")||(o.length<1)||o.hasClass("toHighlight")){m.addClass("hide-expand")}}else{if(o.hasClass("toHighlight")&&n.hasClass("toHighlight")){m.addClass("hide-expand")}}}})});i.$s.filter(".noHighlight").removeClass("noHighlight highlight expanded expansion",b.animSpeed*2,function(){var k=a(this);if(k.data("isHighlighted")){k.younger(b).removeData("isHighlighted")}i._syncNotesPosition(k)});i.$s.filter(".toHighlight").removeClass("toHighlight expanded expansion").addClass("highlight",b.animSpeed*2,function(){var k=a(this);var l=k.data("isHighlighted");k.data("isHighlighted",true);if(l){if(e===true){k.older(b)}else{if(e===false){k.younger(b)}}}i._syncNotesPosition(k)});i._putState()},_getState:function(c){var b=this;var d=b.options;if(c===undefined){c=d.metadata}return a.jStorage.get(c)},_putState:function(c){var b=this;var d=b.options;if(c===undefined){c=d.metadata}var e={threshold:d.threshold,filter:d.filter,starred:b.starred,notes:b.notes};a.jStorage.set(c,e)},_computeThreshold:function(){var d=this;var g=d.options;var e=0;var b={min:-1,max:100};for(var f=d.ranks.length-1;f>0;f--){var c=d.ranks[f];if(c===undefined){continue}e+=c.length;if(e>g.showSentences){b.min=Math.floor(f/10)*10;break}}return b},_isVisible:function(b){return(b.filter(".highlight,.expanded,.expansion,.keyworded").length>0)},_starOn:function(b){var c=this;var e=c.options;var d=c.$s.index(b);b.addClass("starred");c.starred[d]=true;return this},_starOff:function(b){var c=this;var e=c.options;var d=c.$s.index(b);b.removeClass("starred");c.starred[d]=false;return this},_toggleStar:function(b){var c=this;if(b.hasClass("starred")){c._starOff(b)}else{c._starOn(b)}return this},_syncNotesPosition:function(b){var c=this;var d=c.options;var e=c._isVisible(b);b.find(".tagged").each(function(){var g=a(this);var f=g.data("notes-associate");if(!f){g.removeData("notes-associate");g.removeClass(".tagged");return}f.notes((e?"show":"hide"))})},_syncNotesPositions:function(){var b=this;var c=b.options;b.$s.each(function(){b._syncNotesPosition(a(this))})},_expand:function(e){var h=this;var b=h.options;var f=e.parents("p:first");var i=e.find(".controls .expand");var c=e.prev();var d=e.next();var j=1;var g=function(){var k=a(this);k.addClass("expansion");k.css("display","");i.attr("title","collapse");if(--j<1){h._syncNotesPositions()}};if(e.data("isExpanding")||e.hasClass("expanded")){return}e.data("isExpanding",true);e.addClass("expanded",b.animSpeed,g);if(!h._isVisible(c)){j++;c.addClass("expansion",b.animSpeed,g)}if(!h._isVisible(d)){j++;d.addClass("expansion",b.animSpeed,g)}e.removeData("isExpanding");return this},_collapse:function(g){var i=this;var b=i.options;var h=g.parents("p:first");var j=g.find(".controls .expand");var d=g.prev();var f=g.next();var k=1;var c=function(){if(--k>0){return}g.removeClass("expansion");if(!g.hasClass("highlight")){g.removeClass("ui-hover");g.find(".controls .su-icon").css("opacity","");g.find(".selection-controls").remove()}j.attr("title","expand");i._syncNotesPositions();g.removeData("isCollapsing")};var e=function(l){k++;l.removeClass("expansion",b.animSpeed,c);if(l.hasClass("expanded")){i._collapse(l)}};if(g.data("isCollapsing")){return}if(g.hasClass("expanded")){g.removeClass("expanded",b.animSpeed)}else{if(!g.hasClass("expansion")){return}}g.data("isCollapsing",true);if(d.hasClass("expansion")){e(d)}if(f.hasClass("expansion")){e(f)}c();return this},_toggleExpand:function(b){var c=this;var e=c.options;var d=b.find(".controls .expand");if(b.hasClass("expanded")){c._collapse(b)}else{c._expand(b)}return this},_changeFilter:function(d,g){var b=this;var f=b.options;var c=b.$control.find("[name=threshold-up],[name=threshold-down]");var e=(d?d.split(/\s*,\s*/):["normal"]);a.each(e,function(){switch(this.toString()){case"tagged":c.button("disable");break;case"starred":c.button("disable");break;case"normal":default:d="normal";c.button("enable");b.$filters.checkbox("uncheck");break}});f.filter=d;b.element.removeClass("starred tagged normal").addClass(e.join(" "));if(g!==true){b.refresh()}return b},_generateRange:function(e){if(e===undefined){e=rangy.getSelection()}var j=this;var b=j.options;var c=e.getAllRanges();var d=c[0];var g=c[c.length-1];var i=a(d.startContainer).parents(".sentence:first");var f=a(g.endContainer).parents(".sentence:first");var h={start:j.$s.index(i)+"/"+rangy.serializePosition(d.startContainer,d.startOffset,i.find(".content")[0]),end:j.$s.index(f)+"/"+rangy.serializePosition(g.endContainer,g.endOffset,f.find(".content")[0])};console.log("_generateRange: "+h.start+","+h.end);return h.start+","+h.end},_addNotes:function(i,g,f){var j=this;var h=j.options;var s;if((!g)||(!g instanceof a.Notes)){s=(g&&(g.id!==undefined)?g.id:j.notes.length);g={id:s,range:i}}else{s=g.getId()}var k=/^([0-9]+)\/([0-9\/]+:[0-9]+)$/;var c=i.split(/\s*,\s*/);var r=c[0].match(k);var m=c[1].match(k);var n=a(j.$s.get(r[1]));var p=a(j.$s.get(m[1]));var e=rangy.deserializePosition(r[2],n.find(".content")[0]);var d=rangy.deserializePosition(m[2],p.find(".content")[0]);var o=rangy.createRange();var l=rangy.getSelection();o.setStart(e.node,e.offset);o.setEnd(d.node,d.offset);l.removeAllRanges();l.setSingleRange(o);j.cssTag.applyToSelection();var c=l.getAllRanges();var q=a(c[0].startContainer).parent();c[0].getNodes([3],function(t){var u=a(t).parent();if(u.hasClass("tagged")){u.attr("name","summary-notes-"+s)}});l.removeAllRanges();var b=a("<div />").notes({notes:g,position:{of:q},hidden:(f?true:false)});j.notes[s]=b.notes("serialize");q.data("summary-notes",b);b.data("notes-associate",q);q.data("notes-associate",b);if(j._noPut!==true){j._putState()}return q},_removeNotes:function(e){var c=this;var f=c.options;var b=e.data("summary-notes");if(!b){return}var h=b.notes("id");var d="summary-notes-"+h;var g=c.element.find("[name="+d+"]");b.removeData("tagged-item").notes("destroy");e.removeData("summary-notes");c.notes[h]=undefined;g.each(function(){var i=a(this);i.replaceWith(i.html())});c._putState()},_bindEvents:function(){var b=this;var d=b.options;var e=b.element.parent();var c=e.parent();c.delegate(".controls input, .controls button","click",function(){var g=a(this);var f=g.attr("name");var h=d.threshold.min;switch(f){case"threshold-all":d.threshold.min=0;b._changeFilter();break;case"threshold-reset":if(b.origThreshold===undefined){b.origThreshold=b._computeThreshold()}d.threshold.min=b.origThreshold.min;b.$s.removeClass("old-0 old-1 old-2 old-3 old-4 old-5 old-6 old-7 old-8").removeData("age");b._changeFilter();break;case"threshold-down":if(h>9){h-=10}b.threshold(h,d.threshold.max);break;case"threshold-up":if(h<(d.threshold.max-9)){h+=10}b.threshold(h,d.threshold.max);break}});c.delegate(".controls .filter","change",function(k,j){var g=a(this);var h=a(k.target);var f=h.attr("name");switch(f){case"filter":var i=b.$filters.map(function(){return a(this).checkbox("val")});b._changeFilter(a.makeArray(i).join(","));break}});c.delegateHoverIntent(".keyword",function(i){var h=a(this);if((i.type==="hover-in")&&h.hasClass("ui-state-highlight")){return}var f=h.attr("name");var g=b.$kws.filter("[name="+f+"]");switch(i.type){case"hover-out":g.removeClass("keyword-hover");break;case"hover-in":g.addClass("keyword-hover");break}});e.delegateHoverIntent(".rank",function(g){var f=a(this);switch(g.type){case"hover-out":b.$s.find(".rank").css("opacity",d.rankOpacity);g.stopPropagation();break;case"hover-in":b.$s.find(".rank").css("opacity",1);break}});e.delegateHoverIntent(".sentence",function(h){var f=a(this);var g=f.parents("p:first");if(f.data("isCollapsing")||(!b._isVisible(f))){return}b.$s.removeClass("ui-hover");switch(h.type){case"hover-in":f.addClass("ui-hover");break}});e.delegate(".sentence .controls .su-icon","mouseenter mouseleave",function(g){var f=a(this);switch(g.type){case"mouseenter":f.css("opacity",1);break;case"mouseleave":f.css("opacity","");break}});e.delegate(".sentence .controls .su-icon","click",function(i){var g=a(this);var f=g.parents(".sentence:first");var h=false;console.log("control click: "+g.attr("class"));if(g.hasClass("star")){b._toggleStar(f);h=true}else{if(g.hasClass("expand")){b._toggleExpand(f);h=true}}if(h){i.stopPropagation();return false}});e.delegate("p","click",function(j){var h=a(this);var k=a(j.target);var f;if((!k.is("p"))&&(!k.hasClass("sentence"))){k=k.parents(".sentence:first")}if(k.hasClass("sentence")){if(b._isVisible(k)){return}f=k}else{var g=h.find(".sentence");g.each(function(){var l=a(this);var m=l.offset();m.top-=2;m.left-=2;m.right=m.left+l.width()+4;m.bottom=m.top+l.height()+4;if((j.pageX>=m.left)&&(j.pageX<=m.right)&&(j.pageY>=m.top)&&(j.pageY<=m.bottom)){f=l;return false}});if((f===undefined)||(b._isVisible(f))){return}}if(f.hasClass("hide-expand")){var i=f.siblings(".highlight:first");if(i.length<1){i=f.siblings(":not(.hide-expand):first");if(i.length<1){f.removeClass("hide-expand");i=f}}b._toggleExpand(i)}else{b._toggleExpand(f)}});e.delegate("header .keyword","click",function(){var h=a(this);var i=(!h.hasClass("ui-state-highlight"));var f=h.attr("name");var g=e.find("article p .keyword");var j=g.filter("[name="+f+"]");if(i){b.$s.filter(".highlight,.expansion").older(d);h.addClass("ui-state-highlight");j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.addClass("ui-state-highlight");k.addClass("keyworded",d.animSpeed)})}else{j.each(function(){var m=a(this);var k=m.parents(".sentence:first");var l=k.parent();m.removeClass("ui-state-highlight");var n=k.find(".keyword.ui-state-highlight").length;if(n<1){k.removeClass("keyworded",d.animSpeed)}});b.$s.filter('[class*=" old"]').younger(d);h.removeClass("ui-state-highlight")}});e.delegate(".sentence .selection-controls .su-icon","mousedown mouseup",function(j){var h=a(j.target);var g=h.parents(".selection-controls:first");console.log("selection-controls "+j.type+": "+h.attr("class"));switch(j.type){case"mousedown":g.data("mousedown",true);break;case"mouseup":if(!g.data("mousedown")){return}var f=g.parent();g.removeData("mousedown").remove();if(h.hasClass("tag")){var i=rangy.getSelection();b.cssSelect.undoToSelection();range=b._generateRange(i);i.removeAllRanges();b._addNotes(range)}else{b._removeNotes(f)}break}j.preventDefault();j.stopPropagation();return false});e.delegateHoverIntent("article .sentence .tagged",function(k){var i=a(this);var h=i.attr("name");var j=b.element.find("[name="+h+"]:first");var g=j.data("notes-associate");switch(k.type){case"hover-in":b._ignoreHoverOut=false;a("#tmpl-selection-remove-controls").tmpl().appendTo(j).css({top:-22,left:0});if(g){g.notes("activate")}break;case"hover-out":if(g&&(b._ignoreHoverOut!==true)){g.notes("deactivate")}b._ignoreHoverOut=false;var f=i.parents(".sentence:first");f.find(".selection-controls").remove();break}});e.delegate("article .sentence .tagged","click",function(j){var h=a(this);var g=h.attr("name");var i=b.element.find("[name="+g+"]:first");var f=i.data("notes-associate");f.notes("focus");b._ignoreHoverOut=true;return false});e.delegate("article .sentence","mouseup",function(i){var f=a(this);var g=a(i.target);var h=rangy.getSelection();var k=h.toString();e.find(".selection-controls").remove();e.find(".selected").each(function(){var l=a(this);if(l.hasClass("keyword")){l.removeClass("selected")}else{l.replaceWith(l.html())}});if(k.length<1){return}b.cssSelect.applyToSelection();var j=b.element.find(".selected:first");a("#tmpl-selection-controls").tmpl().appendTo(j).css({top:-22,left:0})});b.$notes.delegate(".notes","notes-changed note-change note-destroyed",function(){var g=a(this);var f=g.notes("notesCount");if(f<1){var h=g.data("notes-associate");b._removeNotes(h)}else{var i=g.notes("id");b.notes[i]=g.notes("serialize");if(b._noPut!==true){b._putState()}}})},_unbindEvents:function(){var b=this;var d=b.element.parent();var c=d.parent();c.undelegate(".controls input, .controls button","click");d.undelegate("p","click");d.undelegateHoverIntent(".rank");d.undelegateHoverIntent(".sentence");d.undelegate(".sentence .controls .su-icon","mouseenter mouseleave click");d.undelegate("header .keyword","click");d.undelegate(".sentence .selection-controls .su-icon","mousedown mouseup");d.undelegateHoverIntent("article .sentence .tagged");d.undelegate("article .sentence .tagged","click");d.undelegate("article .sentence","mouseup");b.$notes.undelegate(".notes","notes-changed note-change note-destroyed")}};a.fn.older=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c>=0){c++}else{c=0}d.data("age",c);d.addClass("old-"+c,b.animSpeed)})};a.fn.younger=function(b){b=a.extend({animSpeed:100},b||{});return this.each(function(){var d=a(this);var c=d.data("age");if(c===undefined){c=0}d.removeClass("old-"+c,b.animSpeed);if(c>=0){c--}d.data("age",c)})}}(jQuery));